<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Training Progress Tracker v2.2</title>
    <script src="https://unpkg.com/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <style>
        input[type="text"]:not([disabled]),
        select:not([disabled]),
        textarea {
            text-transform: uppercase;
        }

        input[type="date"] {
            text-transform: none;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        * {
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .data-table {
            border-spacing: 0;
            table-layout: auto;
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .data-table th.sticky,
        .data-table td.sticky {
            position: sticky;
            right: 0;
            z-index: 10;
        }

        .data-table th.sticky {
            z-index: 11;
        }

        .data-table thead {
            position: sticky;
            top: 0;
            z-index: 20;
        }

        .data-table thead th.sticky {
            z-index: 21;
        }

        .data-table tbody tr.bg-blue-50 td.sticky {
            background-color: #eff6ff;
        }

        .data-table tbody tr.bg-green-50 td.sticky {
            background-color: #f0fdf4;
        }

        .data-table tbody tr.bg-red-50 td.sticky {
            background-color: #fef2f2;
        }

        .data-table tbody tr:not([class*="bg-"]) td.sticky {
            background-color: white;
        }

        .data-table tbody tr:hover td.sticky {
            box-shadow: -4px 0 8px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            position: relative;
            overflow: hidden;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        input:focus, select:focus, textarea:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Sortable column headers */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 20px !important;
        }

        .sortable-header:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .sortable-header::after {
            content: '‚áÖ';
            position: absolute;
            right: 5px;
            opacity: 0.3;
            font-size: 12px;
        }

        .sortable-header.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
            color: #3b82f6;
        }

        .sortable-header.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
            color: #3b82f6;
        }

        /* Copy button animation */
        .copy-btn {
            transition: all 0.2s;
        }

        .copy-btn:active {
            transform: scale(0.95);
        }

        .copy-success {
            animation: copyPulse 0.3s ease;
        }

        @keyframes copyPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); background-color: #10b981; }
        }

        /* Validation errors */
        .validation-error {
            border-color: #ef4444 !important;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Auto-save indicator */
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .save-indicator.saving {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #3b82f6;
            color: white;
        }

        .save-indicator.saved {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #10b981;
            color: white;
        }

        .save-indicator.error {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #ef4444;
            color: white;
        }

        @media (max-width: 768px) {
            .desktop-table {
                display: none !important;
            }
            
            .mobile-cards {
                display: block !important;
            }
            
            button {
                min-height: 44px;
                min-width: 44px;
            }
            
            input, select, textarea {
                min-height: 44px;
                font-size: 16px !important;
            }
            
            input[type="date"] {
                font-size: 16px !important;
            }
            
            .mobile-header-compact {
                padding: 1rem !important;
            }
            
            .mobile-header-compact h1 {
                font-size: 1.5rem !important;
            }
            
            .mobile-header-compact img {
                height: 2.5rem !important;
            }
            
            .mobile-card {
                background: white;
                border-radius: 12px;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                border-left: 4px solid #e5e7eb;
            }
            
            .mobile-card.highlight-blue {
                border-left-color: #3b82f6;
                background: #eff6ff;
            }
            
            .mobile-card.highlight-green {
                border-left-color: #10b981;
                background: #f0fdf4;
            }
            
            .mobile-card.highlight-red {
                border-left-color: #ef4444;
                background: #fef2f2;
            }
            
            .mobile-actions {
                display: flex;
                gap: 0.5rem;
                flex-wrap: wrap;
                margin-top: 0.75rem;
            }
            
            .mobile-actions button {
                flex: 1;
                min-width: 60px;
                padding: 0.5rem;
                font-size: 0.875rem;
            }
        }
        
        @media (min-width: 769px) {
            .mobile-cards {
                display: none !important;
            }
            
            .desktop-table {
                display: block !important;
            }
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 1.5rem;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .chart-container {
            position: relative;
            height: 300px;
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 via-blue-50 to-gray-50 min-h-screen">
    <div class="min-h-screen p-4 md:p-6">
        <div class="max-w-7xl mx-auto">
            <div class="gradient-bg rounded-2xl shadow-2xl p-8 md:p-8 p-4 mb-6 animate-slide-in mobile-header-compact">
                <div class="flex items-center gap-3 md:gap-6">
                    <div class="flex-shrink-0 bg-white rounded-xl p-2 md:p-3 shadow-lg">
                        <img src="malaysia-airlines-logo.png" alt="Malaysia Airlines Logo" class="h-12 md:h-20 w-auto object-contain">
                    </div>
                    <div class="text-white flex-1">
                        <h1 class="text-2xl md:text-5xl font-bold tracking-tight">Training Progress Tracker</h1>
                        <p class="text-sm md:text-base opacity-90 mt-1">v2.2 - Advanced Analytics</p>
                    </div>
                    <div id="userInfo" class="hidden bg-white/20 backdrop-blur-sm px-2 md:px-4 py-2 rounded-xl">
                        <p class="text-white text-xs md:text-sm font-medium" id="userName"></p>
                        <button id="signOutBtn" class="text-white text-xs underline hover:text-blue-200">Sign Out</button>
                    </div>
                </div>
            </div>

            <div id="signInScreen" class="bg-white rounded-2xl shadow-xl p-8 max-w-md mx-auto animate-slide-in">
                <div class="text-center mb-8">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <span class="text-4xl text-white">üîí</span>
                    </div>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Sign In Required</h2>
                    <p class="text-gray-600">Sign in with your Google account to access the Training Progress Tracker</p>
                </div>
                <div class="flex justify-center mb-4">
                    <div id="g_id_signin">
                        <div class="text-center p-4">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <p class="text-sm text-gray-600 mt-2">Loading sign-in...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="mainApp" class="hidden">
                <div class="bg-white rounded-xl shadow-lg p-2 mb-6 animate-fade-in">
                    <div class="flex gap-2">
                        <button id="cadetViewBtn" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-all duration-200 bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-md hover:shadow-lg">
                            User Portal
                        </button>
                        <button id="adminViewBtn" class="flex-1 px-6 py-3 rounded-lg font-semibold transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200">
                            Admin Panel
                        </button>
                    </div>
                </div>

                <div id="cadetView" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 animate-fade-in">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-1 h-8 bg-gradient-to-b from-blue-600 to-blue-400 rounded-full"></div>
                        <h2 class="text-3xl font-bold text-gray-800">Self-Service Portal</h2>
                    </div>
                    
                    <div class="max-w-2xl">
                        <div class="mb-8">
                            <label class="block text-gray-700 font-semibold mb-3 text-lg">Staff ID</label>
                            <div class="flex gap-3">
                                <input type="text" id="cadetStaffId" class="flex-1 px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-lg" placeholder="Enter your Staff ID">
                                <button id="loadCadetBtn" class="btn-primary px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-semibold hover:from-blue-700 hover:to-blue-800 shadow-md hover:shadow-lg transition-all">
                                    Load Info
                                </button>
                            </div>
                        </div>

                        <div id="cadetFormSection" class="hidden">
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-5 rounded-xl mb-8 shadow-sm">
                                <div class="flex items-start gap-3">
                                    <div class="text-2xl">‚ÑπÔ∏è</div>
                                    <div>
                                        <p class="text-sm text-blue-900 font-medium mb-1">Important Notes</p>
                                        <p class="text-sm text-blue-800">‚Ä¢ Rank field locks after first selection</p>
                                        <p class="text-sm text-blue-800">‚Ä¢ Date fields use calendar picker</p>
                                        <p class="text-sm text-blue-800">‚Ä¢ All fields can be updated anytime</p>
                                        <p class="text-sm text-blue-800">‚Ä¢ Sectors field is optional</p>
                                    </div>
                                </div>
                            </div>

                            <div class="space-y-5 mb-8">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Rank</label>
                                    <select id="cadetRank" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                        <option value="">Select your rank...</option>
                                        <option value="CAPT">CAPT</option>
                                        <option value="FO">FO</option>
                                        <option value="SO">SO</option>
                                        <option value="CDT">CDT</option>
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Name</label>
                                    <input type="text" id="cadetNameDisplay" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl bg-gray-50" disabled>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2">First IOE Date</label>
                                        <input type="date" id="cadetFirstIOE" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2">Functional Date</label>
                                        <input type="date" id="cadetFunctional" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2">LRC Date</label>
                                        <input type="date" id="cadetLRC" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2">Interview Date</label>
                                        <input type="date" id="cadetInterview" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">Total Sectors Flown (Optional)</label>
                                    <input type="number" id="newSectorCount" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all text-lg font-bold" placeholder="Enter total sector count" min="0">
                                    <div id="currentSectorsDisplay" class="hidden mt-2 p-3 bg-blue-50 border-l-4 border-blue-500 rounded">
                                        <p class="text-sm text-blue-900">
                                            <span class="font-bold">Current sectors:</span> 
                                            <span id="currentSectorsValue" class="text-lg font-black text-blue-700"></span>
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <button id="updateCadetBtn" class="btn-primary w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-green-800 shadow-lg hover:shadow-xl transition-all">
                                Save All Updates
                            </button>

                            <div id="updateMessage" class="mt-4 p-4 rounded-xl hidden shadow-sm"></div>
                        </div>
                    </div>

                    <!-- Advanced Analytics Section -->
                    <div id="analyticsSection" class="mt-10 hidden">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-1 h-8 bg-gradient-to-b from-purple-600 to-purple-400 rounded-full"></div>
                            <h3 class="text-2xl font-bold text-gray-800">üìä Advanced Analytics</h3>
                        </div>

                        <!-- Quick Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div class="stat-card">
                                <div class="text-sm opacity-80 mb-1">Total Sectors</div>
                                <div class="text-3xl font-bold" id="userTotalSectors">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="text-sm opacity-80 mb-1">30-Day Average</div>
                                <div class="text-3xl font-bold" id="user30DayAvg">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="text-sm opacity-80 mb-1">Weekly Rate</div>
                                <div class="text-3xl font-bold" id="userWeeklyRate">0</div>
                            </div>
                        </div>

                        <!-- Progress Chart -->
                        <div class="mb-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-3">üìà 30-Day Progress</h4>
                            <div class="chart-container">
                                <canvas id="userProgressChart"></canvas>
                            </div>
                        </div>

                        <!-- Batch Comparison -->
                        <div class="mb-6">
                            <h4 class="text-lg font-bold text-gray-800 mb-3">üéØ Batch Comparison</h4>
                            <div class="chart-container">
                                <canvas id="userBatchChart"></canvas>
                            </div>
                        </div>

                        <!-- Detailed Metrics -->
                        <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-6 border border-gray-200">
                            <h4 class="text-lg font-bold text-gray-800 mb-4">üìä Detailed Metrics</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Last 7 Days</div>
                                    <div class="text-2xl font-bold text-blue-700" id="userLast7Days">0</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Last 30 Days</div>
                                    <div class="text-2xl font-bold text-blue-700" id="userLast30Days">0</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Batch Average</div>
                                    <div class="text-2xl font-bold text-purple-700" id="userBatchAverage">0</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Difference</div>
                                    <div class="text-2xl font-bold" id="userDifference">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="adminView" class="hidden">
                    <div id="adminLogin" class="bg-white rounded-2xl shadow-xl p-8 max-w-md mx-auto animate-slide-in">
                        <div class="text-center mb-8">
                            <div class="w-20 h-20 bg-gradient-to-br from-green-500 to-green-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                                <span class="text-4xl text-white">üîì</span>
                            </div>
                            <h2 class="text-3xl font-bold text-gray-800 mb-2">Admin Access</h2>
                            <p class="text-gray-600">Two ways to authenticate:</p>
                        </div>
                        
                        <div class="mb-6 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                            <p class="text-sm text-blue-900 font-semibold mb-2">üîπ Email-based (Recommended)</p>
                            <p class="text-xs text-blue-800">Your email (<span id="adminCheckEmail">loading...</span>) will be checked against admin list</p>
                        </div>
                        
                        <div class="mb-6 p-4 bg-green-50 border-l-4 border-green-500 rounded">
                            <p class="text-sm text-green-900 font-semibold mb-2">üîπ Password-based (Optional)</p>
                            <p class="text-xs text-green-800">Enter password if set in AdminUsers sheet (B1)</p>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-3">Password (optional)</label>
                            <input type="password" id="adminPassword" class="w-full px-5 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" placeholder="Leave blank for email auth">
                        </div>
                        <button id="adminLoginBtn" class="btn-primary w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-4 rounded-xl font-bold text-lg hover:from-green-700 hover:to-green-800 shadow-lg hover:shadow-xl transition-all">
                            Verify Access
                        </button>
                        
                        <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                            <p class="text-xs text-gray-600 font-semibold mb-2">üìã Setup:</p>
                            <ol class="text-xs text-gray-600 space-y-1 list-decimal list-inside">
                                <li>Create sheet "AdminUsers"</li>
                                <li>Add admin emails in column A</li>
                                <li>Optional: password in cell B1</li>
                                <li>Hide the sheet</li>
                            </ol>
                        </div>
                    </div>

                    <div id="adminDashboard" class="hidden animate-fade-in">
                        <div id="adminMainContent">
                        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
                            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4 mb-6">
                                <h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2>
                                <div class="flex flex-col gap-2">
                                    <div class="flex flex-wrap gap-3">
                                        <button id="refreshDataBtn" class="btn-primary flex items-center gap-2 bg-gradient-to-r from-cyan-600 to-cyan-700 text-white px-4 py-2.5 rounded-lg font-semibold hover:from-cyan-700 hover:to-cyan-800 shadow-md hover:shadow-lg transition-all" title="Refresh data and highlights">
                                            üîÑ Refresh
                                        </button>
                                        <button id="viewAnalyticsBtn" class="btn-primary flex items-center gap-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-4 py-2.5 rounded-lg font-semibold hover:from-purple-700 hover:to-purple-800 shadow-md hover:shadow-lg transition-all" title="View batch analytics">
                                            üìä Analytics
                                        </button>
                                        <button id="viewHistoryBtn" class="btn-primary flex items-center gap-2 bg-gradient-to-r from-indigo-600 to-indigo-700 text-white px-4 py-2.5 rounded-lg font-semibold hover:from-indigo-700 hover:to-indigo-800 shadow-md hover:shadow-lg transition-all" title="View recent changes">
                                            üìù History
                                        </button>
                                        <button id="testHighlightsBtn" class="btn-primary flex items-center gap-2 bg-gradient-to-r from-yellow-600 to-yellow-700 text-white px-4 py-2.5 rounded-lg font-semibold hover:from-yellow-700 hover:to-yellow-800 shadow-md hover:shadow-lg transition-all" title="Test highlight visibility">
                                            üé® Test Colors
                                        </button>
                                        <button id="exportExcelBtn" class="btn-primary flex items-center gap-2 bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2.5 rounded-lg font-semibold hover:from-green-700 hover:to-green-800 shadow-md hover:shadow-lg transition-all" title="Export with colors, frozen header, and borders">
                                            üì• Export Excel
                                        </button>
                                        <button id="exportPowerBIBtn" class="btn-primary flex items-center gap-2 bg-gradient-to-r from-orange-600 to-orange-700 text-white px-4 py-2.5 rounded-lg font-semibold hover:from-orange-700 hover:to-orange-800 shadow-md hover:shadow-lg transition-all" title="Clean format with frozen header and borders">
                                            üìä Power BI
                                        </button>
                                        <button id="addCadetBtn" class="btn-primary flex items-center gap-2 bg-gradient-to-r from-purple-600 to-purple-700 text-white px-4 py-2.5 rounded-lg font-semibold hover:from-purple-700 hover:to-purple-800 shadow-md hover:shadow-lg transition-all">
                                            ‚ûï Add
                                        </button>
                                        <button id="bulkImportBtn" class="btn-primary flex items-center gap-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-4 py-2.5 rounded-lg font-semibold hover:from-blue-700 hover:to-blue-800 shadow-md hover:shadow-lg transition-all" title="Import multiple trainees from Excel">
                                            üì§ Bulk Import
                                        </button>
                                    </div>
                                    <div id="exportFilterNotice" class="hidden text-xs text-orange-700 bg-orange-50 px-3 py-1.5 rounded-lg border border-orange-200">
                                        üí° Exports include only filtered trainees
                                    </div>
                                </div>
                            </div>

                            <!-- Add Cadet Form -->
                            <div id="addCadetForm" class="bg-gradient-to-br from-gray-50 to-blue-50 p-6 rounded-xl mb-6 hidden border border-gray-200 shadow-sm">
                                <h3 class="text-xl font-bold text-gray-800 mb-5">Add New Trainee</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Staff ID</label>
                                        <input type="text" id="newCadetStaffId" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Rank</label>
                                        <select id="newCadetRank" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                            <option value="">Select...</option>
                                            <option value="CAPT">CAPT</option>
                                            <option value="FO">FO</option>
                                            <option value="SO">SO</option>
                                            <option value="CDT">CDT</option>
                                        </select>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Name</label>
                                        <input type="text" id="newCadetName" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Batch</label>
                                        <div class="flex gap-2">
                                            <select id="newCadetBatch" class="flex-1 px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                                <option value="">Select batch...</option>
                                            </select>
                                            <button type="button" id="toggleNewBatchBtn" class="px-4 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-semibold transition-all whitespace-nowrap" title="Create new batch">
                                                ‚ûï New
                                            </button>
                                        </div>
                                        <div id="newBatchInput" class="hidden mt-2">
                                            <input type="text" id="newBatchName" placeholder="Enter new batch name (e.g., 24CPC01)" class="w-full px-4 py-2.5 border-2 border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all">
                                            <p class="text-xs text-gray-600 mt-1">üí° Format: YYCPCXX (e.g., 24CPC01, 25CPC02)</p>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">First IOE</label>
                                        <input type="date" id="newCadetIOE" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Functional</label>
                                        <input type="date" id="newCadetFunctional" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">LRC</label>
                                        <input type="date" id="newCadetLRC" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                    </div>
                                    <div>
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Interview</label>
                                        <input type="date" id="newCadetInterview" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Sectors</label>
                                        <input type="number" id="newCadetSectors" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" min="0" value="0">
                                    </div>
                                    <div class="md:col-span-2 flex gap-3 mt-2">
                                        <button id="submitCadetBtn" class="flex-1 bg-gradient-to-r from-purple-600 to-purple-700 text-white py-3 rounded-lg hover:from-purple-700 hover:to-purple-800 font-bold shadow-md hover:shadow-lg transition-all">
                                            Add
                                        </button>
                                        <button id="cancelAddBtn" class="flex-1 bg-gray-400 text-white py-3 rounded-lg hover:bg-gray-500 font-bold shadow-md hover:shadow-lg transition-all">
                                            Cancel
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Filters -->
                            <div class="mb-6 p-6 bg-gradient-to-br from-gray-50 to-blue-50 rounded-xl border border-gray-200 shadow-sm">
                                <h3 class="text-lg font-bold text-gray-800 mb-4">üîç Filters</h3>
                                
                                <div class="mb-4">
                                    <input type="text" id="searchBox" placeholder="Search..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all">
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                                    <div>
                                        <select id="yearFilter" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-semibold">
                                            <option value="all">All Years</option>
                                        </select>
                                    </div>
                                    <div>
                                        <select id="batchFilter" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-semibold">
                                            <option value="all">All Batches</option>
                                        </select>
                                    </div>
                                    <div>
                                        <select id="rankFilter" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-semibold">
                                            <option value="all">All Ranks</option>
                                            <option value="CAPT">CAPT</option>
                                            <option value="FO">FO</option>
                                            <option value="SO">SO</option>
                                            <option value="CDT">CDT</option>
                                        </select>
                                    </div>
                                    <div>
                                        <select id="statusFilter" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-semibold">
                                            <option value="all">All Status</option>
                                            <option value="completed">‚úÖ Completed</option>
                                            <option value="functional">üîµ Functional</option>
                                            <option value="special">üî¥ Special</option>
                                            <option value="inprogress">‚è≥ In Progress</option>
                                        </select>
                                    </div>
                                    <div>
                                        <select id="updateFilter" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-semibold">
                                            <option value="all">Any Time</option>
                                            <option value="today">üü¢ Today</option>
                                            <option value="week">üü° This Week</option>
                                            <option value="old">üî¥ Over 7 Days</option>
                                            <option value="never">‚ö´ Never</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                                    <div class="flex items-center gap-3">
                                        <span id="filterCount" class="text-sm text-gray-700 font-semibold"></span>
                                        <div id="paginationControls" class="flex items-center gap-2">
                                            <label class="text-xs text-gray-600">Show:</label>
                                            <select id="rowsPerPage" class="px-2 py-1 border border-gray-300 rounded text-xs">
                                                <option value="all">All</option>
                                                <option value="25">25 rows</option>
                                                <option value="50">50 rows</option>
                                                <option value="100">100 rows</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div id="pageNavigation" class="hidden flex items-center gap-2">
                                            <button id="prevPageBtn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                                ‚Üê Prev
                                            </button>
                                            <span id="pageInfo" class="text-xs text-gray-600"></span>
                                            <button id="nextPageBtn" class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 text-xs disabled:opacity-50 disabled:cursor-not-allowed">
                                                Next ‚Üí
                                            </button>
                                        </div>
                                        <button id="clearFiltersBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold shadow-sm hover:shadow transition-all">
                                            üîÑ Clear All
                                        </button>
                                        <button id="toggleCompletedBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold shadow-sm hover:shadow transition-all" title="Hide/Show completed trainees">
                                            üëÅÔ∏è Hide Completed
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Stats -->
                            <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">
                                <h4 class="text-sm font-bold text-green-800 mb-2">üì• Export Features:</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-xs text-green-700">
                                    <div>
                                        <strong>Excel Export:</strong>
                                        <ul class="list-disc list-inside ml-2 mt-1">
                                            <li>Color-coded rows (Blue/Green/Red)</li>
                                            <li>Frozen header row</li>
                                            <li>Cell borders for clarity</li>
                                            <li>Batch groupings</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <strong>Power BI Export:</strong>
                                        <ul class="list-disc list-inside ml-2 mt-1">
                                            <li>Clean tabular format</li>
                                            <li>Frozen header row</li>
                                            <li>Cell borders</li>
                                            <li>Analytics-ready columns</li>
                                        </ul>
                                    </div>
                                </div>
                                <p class="text-xs text-green-600 mt-2">üí° Both exports respect your active filters</p>
                            </div>

                            <!-- Stats -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-6">
                                <div class="card bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl shadow-md border border-blue-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="text-blue-600 text-sm font-bold uppercase" id="statsLabel1">Total</div>
                                        <span class="text-2xl">üë•</span>
                                    </div>
                                    <div class="text-4xl font-black text-blue-900" id="statsCadets">0</div>
                                </div>
                                <div class="card bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl shadow-md border border-green-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="text-green-600 text-sm font-bold uppercase">Sectors</div>
                                        <span class="text-2xl">‚úàÔ∏è</span>
                                    </div>
                                    <div class="text-4xl font-black text-green-900" id="statsSectors">0</div>
                                </div>
                                <div class="card bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl shadow-md border border-purple-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="text-purple-600 text-sm font-bold uppercase">Average</div>
                                        <span class="text-2xl">üìä</span>
                                    </div>
                                    <div class="text-4xl font-black text-purple-900" id="statsAvg">0</div>
                                </div>
                            </div>

                            <!-- Legend -->
                            <div class="mb-6 p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl border border-gray-200">
                                <div class="mb-3">
                                    <h4 class="text-sm font-bold text-gray-800 mb-2">üé® Color Highlighting System:</h4>
                                    <p class="text-xs text-gray-600 mb-2">Auto-highlights based on date completion + Manual override available</p>
                                </div>
                                <div class="flex flex-wrap gap-4 items-center text-sm">
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 bg-blue-100 border-2 border-blue-300 rounded"></div>
                                        <span class="text-gray-700 font-medium">üîµ Functional (IOE + Func only)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 bg-green-100 border-2 border-green-300 rounded"></div>
                                        <span class="text-gray-700 font-medium">üü¢ Completed (All 4 dates)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 bg-red-100 border-2 border-red-300 rounded"></div>
                                        <span class="text-gray-700 font-medium">üî¥ Special (Manual)</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 bg-white border-2 border-gray-300 rounded"></div>
                                        <span class="text-gray-700 font-medium">‚ö™ In Progress</span>
                                    </div>
                                </div>
                                <div class="mt-3 p-2 bg-blue-50 rounded border border-blue-200">
                                    <p class="text-xs text-blue-800">
                                        <strong>üí° Tip:</strong> Hover over table rows to see highlight reason. 
                                        Click üé® Test Colors to debug. Blue = Has IOE & Functional dates, NO LRC & NO Interview.
                                    </p>
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="desktop-table rounded-xl border-2 border-gray-200 shadow-lg" style="max-height: 600px; overflow-y: auto; overflow-x: auto;">
                                <table class="w-full border-collapse data-table" style="position: relative;">
                                    <thead class="bg-gradient-to-r from-gray-100 to-gray-200" style="position: sticky; top: 0; z-index: 20;">
                                        <tr>
                                            <th class="sortable-header px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 80px; min-width: 80px;"><span data-sort="batch">Batch</span></th>
                                            <th class="sortable-header px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 80px; min-width: 80px;"><span data-sort="staffId">Staff ID</span></th>
                                            <th class="sortable-header px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 50px; min-width: 50px;"><span data-sort="rank">Rank</span></th>
                                            <th class="sortable-header px-3 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="min-width: 150px;"><span data-sort="name">Name</span></th>
                                            <th class="px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 70px; min-width: 70px;">IOE</th>
                                            <th class="px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 70px; min-width: 70px;">Func</th>
                                            <th class="px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 70px; min-width: 70px;">LRC</th>
                                            <th class="px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 70px; min-width: 70px;">Int</th>
                                            <th class="sortable-header px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 60px; min-width: 60px;"><span data-sort="sectorsFlown">Sectors</span></th>
                                            <th class="sortable-header px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 70px; min-width: 70px;"><span data-sort="lastUpdated">Updated</span></th>
                                            <th class="px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase" style="width: 150px; max-width: 150px;">Remarks</th>
                                            <th class="px-2 py-4 text-left text-xs font-bold text-gray-700 uppercase sticky right-0 bg-gray-200 shadow-md" style="width: 130px; min-width: 130px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cadetTableBody" class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td colspan="12" class="text-center py-16 text-gray-500">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="mobile-cards" id="mobileCardsContainer">
                                <div class="text-center py-16 text-gray-500">Loading...</div>
                            </div>
                        </div>

                        </div>
                        <!-- Admin Analytics Dashboard -->
                        <div id="adminAnalyticsDashboard" class="hidden bg-white rounded-2xl shadow-xl p-6 md:p-8 animate-fade-in">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-3xl font-bold text-gray-800">üìä Batch Analytics</h2>
                                <button id="closeAnalyticsBtn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 font-semibold">
                                    ‚Üê Back
                                </button>
                            </div>

                            <!-- Batch Selector -->
                            <div class="mb-6">
                                <label class="block text-gray-700 font-semibold mb-2">Select Batch</label>
                                <select id="analyticsBatchSelect" class="w-full md:w-64 px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 font-semibold">
                                    <option value="all">All Batches Combined</option>
                                </select>
                            </div>

                            <!-- Overview Stats -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="stat-card">
                                    <div class="text-sm opacity-80 mb-1">Trainees</div>
                                    <div class="text-3xl font-bold" id="analyticsTotalTrainees">0</div>
                                </div>
                                <div class="stat-card">
                                    <div class="text-sm opacity-80 mb-1">Total Sectors</div>
                                    <div class="text-3xl font-bold" id="analyticsTotalSectors">0</div>
                                </div>
                                <div class="stat-card">
                                    <div class="text-sm opacity-80 mb-1">Average Sectors</div>
                                    <div class="text-3xl font-bold" id="analyticsAvgSectors">0</div>
                                </div>
                                <div class="stat-card">
                                    <div class="text-sm opacity-80 mb-1">Top Performer</div>
                                    <div class="text-lg font-bold" id="analyticsTopPerformer">-</div>
                                </div>
                            </div>

                            <!-- Charts -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                <div>
                                    <h4 class="text-lg font-bold text-gray-800 mb-3">üìä Sector Distribution</h4>
                                    <div class="chart-container" style="height: 350px;">
                                        <canvas id="adminDistributionChart"></canvas>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-lg font-bold text-gray-800 mb-3">üìà Top 10 Performers</h4>
                                    <div class="chart-container" style="height: 350px;">
                                        <canvas id="adminTop10Chart"></canvas>
                                    </div>
                                </div>
                            </div>

                            <!-- Leaderboard -->
                            <div>
                                <h4 class="text-lg font-bold text-gray-800 mb-3">üèÜ Full Leaderboard</h4>
                                <div class="overflow-x-auto rounded-xl border border-gray-200">
                                    <table class="w-full">
                                        <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                            <tr>
                                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Rank</th>
                                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Name</th>
                                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Batch</th>
                                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">Sectors</th>
                                                <th class="px-6 py-4 text-left text-sm font-bold text-gray-700">vs Average</th>
                                            </tr>
                                        </thead>
                                        <tbody id="analyticsLeaderboard" class="divide-y divide-gray-200"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-save Indicator -->
    <div id="saveIndicator" class="save-indicator">
        <span id="saveIndicatorText">Saving...</span>
    </div>

    <!-- Edit Trainee Modal -->
    <div id="editTraineeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-gradient-to-r from-yellow-500 to-yellow-600 p-6 rounded-t-2xl">
                <div class="flex items-center justify-between">
                    <h3 class="text-2xl font-bold text-white flex items-center gap-2">
                        ‚úèÔ∏è Edit Trainee Data
                    </h3>
                    <button onclick="closeEditModal()" class="text-white hover:text-yellow-200 text-3xl font-bold leading-none">√ó</button>
                </div>
                <p class="text-yellow-100 text-sm mt-2" id="editModalSubtitle">Admin editing mode</p>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Staff ID</label>
                        <input type="text" id="editStaffId" class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg bg-gray-100" disabled>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Rank</label>
                        <select id="editRank" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all">
                            <option value="">Select...</option>
                            <option value="CAPT">CAPT</option>
                            <option value="FO">FO</option>
                            <option value="SO">SO</option>
                            <option value="CDT">CDT</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Name</label>
                        <input type="text" id="editName" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">First IOE Date</label>
                        <input type="date" id="editFirstIOE" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Functional Date</label>
                        <input type="date" id="editFunctional" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">LRC Date</label>
                        <input type="date" id="editLRC" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Interview Date</label>
                        <input type="date" id="editInterview" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Sectors Flown</label>
                        <input type="number" id="editSectors" min="0" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all">
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Batch</label>
                        <input type="text" id="editBatch" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all">
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="block text-gray-700 font-semibold mb-2 text-sm">Remarks</label>
                        <textarea id="editRemarksField" rows="2" class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition-all"></textarea>
                    </div>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="saveTraineeEdit()" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg hover:from-green-700 hover:to-green-800 font-bold shadow-md hover:shadow-lg transition-all">
                        üíæ Save Changes
                    </button>
                    <button onclick="closeEditModal()" class="flex-1 bg-gray-400 text-white py-3 rounded-lg hover:bg-gray-500 font-bold shadow-md hover:shadow-lg transition-all">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="bulkImportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="gradient-bg text-white p-6 rounded-t-2xl">
                <h3 class="text-2xl font-bold">üì§ Bulk Import Trainees</h3>
                <p class="text-sm opacity-90 mt-1">Upload Excel file to add multiple trainees at once</p>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-bold text-blue-900 mb-2">üìã Required Columns:</h4>
                    <ul class="text-sm text-blue-800 space-y-1 ml-4">
                        <li>‚Ä¢ <strong>Batch</strong> (e.g., 24/1A)</li>
                        <li>‚Ä¢ <strong>Staff_ID</strong> (e.g., 123456)</li>
                        <li>‚Ä¢ <strong>Name</strong> (e.g., JOHN DOE)</li>
                        <li>‚Ä¢ <strong>Rank</strong> (optional: FO, SO, CPT, etc.)</li>
                        <li>‚Ä¢ <strong>Sectors_Flown</strong> (optional: number)</li>
                        <li>‚Ä¢ <strong>First_IOE_Date</strong> (optional: DD/MM/YYYY)</li>
                        <li>‚Ä¢ <strong>Functional_Date</strong> (optional: DD/MM/YYYY)</li>
                        <li>‚Ä¢ <strong>LRC_Date</strong> (optional: DD/MM/YYYY)</li>
                        <li>‚Ä¢ <strong>Interview_Date</strong> (optional: DD/MM/YYYY)</li>
                        <li>‚Ä¢ <strong>Remarks</strong> (optional: text)</li>
                    </ul>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Select Excel File</label>
                    <input type="file" id="bulkImportFile" accept=".xlsx,.xls" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div id="bulkImportPreview" class="hidden">
                    <h4 class="font-bold text-gray-800 mb-2">Preview:</h4>
                    <div class="border border-gray-300 rounded-lg p-3 max-h-60 overflow-auto">
                        <div id="bulkImportPreviewContent" class="text-sm"></div>
                    </div>
                </div>
                
                <div class="flex gap-3 pt-4">
                    <button id="processBulkImportBtn" class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        ‚úÖ Import Trainees
                    </button>
                    <button id="cancelBulkImportBtn" class="px-6 py-3 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition-all">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        const CONFIG = {
            API_KEY: 'AIzaSyDkxsnzpdOCXqUJ9xbpWKeoVU9P4hYCrik',
            CLIENT_ID: '657166589265-ocmfi5cgl3rktnakqcd0bjjd0284mv4f.apps.googleusercontent.com',
            SPREADSHEET_ID: '1D31q-19IK0DSLVQaI8jwrxLVspyMIWIZ6thiO7vGoNg',
            SHEET_NAME: '738 cpc'
        };

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;
        let currentUser = null;
        let cadets = [];
        let changeHistory = []; // Track all changes for history
        let hideCompleted = false; // Toggle for hiding completed trainees
        let currentSort = { column: null, direction: 'asc' }; // Track current sort
        let autoSaveTimeout = null; // Debounce auto-save
        let batches = [];
        let currentView = 'cadet';
        let isAdminAuth = false;
        let selectedBatchFilter = 'all';
        let selectedRankFilter = 'all';
        let selectedStatusFilter = 'all';
        let selectedUpdateFilter = 'all';
        let selectedYearFilter = 'all';
        let searchQuery = '';
        let currentPage = 1;
        let rowsPerPage = 'all';
        let userProgressChart = null;
        let userBatchChart = null;
        let adminDistributionChart = null;
        let adminTop10Chart = null;

        function ddmmyyToDatePicker(dateStr) {
            if (!dateStr || dateStr.trim() === '') return '';
            try {
                const parts = dateStr.split('/');
                if (parts.length !== 3) return '';
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                let year = parts[2];
                if (year.length === 2) {
                    const yearNum = parseInt(year);
                    year = yearNum <= 50 ? '20' + year : '19' + year;
                }
                return `${year}-${month}-${day}`;
            } catch (e) {
                return '';
            }
        }

        function datePickerToDdmmyy(dateStr) {
            if (!dateStr || dateStr.trim() === '') return '';
            try {
                const parts = dateStr.split('-');
                if (parts.length !== 3) return '';
                const year = parts[0].slice(-2);
                const month = parts[1];
                const day = parts[2];
                return `${day}/${month}/${year}`;
            } catch (e) {
                return '';
            }
        }

        function calculateAnalytics(cadet, allCadets) {
            const total = cadet.sectorsFlown || 0;
            
            // Mock data for demo - in real app, use sectorHistory
            const last30Days = Math.floor(total * 0.3); // Simulate 30% in last 30 days
            const last7Days = Math.floor(total * 0.1); // Simulate 10% in last 7 days
            
            const avg30Day = last30Days / 30;
            const weeklyRate = (last7Days / 7) * 7; // Weekly rate
            
            // Batch stats
            const batchCadets = allCadets.filter(c => c.batch === cadet.batch);
            const batchTotal = batchCadets.reduce((sum, c) => sum + (c.sectorsFlown || 0), 0);
            const batchAvg = batchCadets.length > 0 ? Math.round(batchTotal / batchCadets.length) : 0;
            
            return {
                total,
                last30Days,
                last7Days,
                avg30Day: Math.round(avg30Day * 10) / 10,
                weeklyRate: Math.round(weeklyRate),
                batchAvg,
                difference: total - batchAvg
            };
        }

        function updateUserAnalytics(cadet) {
            const analytics = calculateAnalytics(cadet, cadets);
            
            document.getElementById('userTotalSectors').textContent = analytics.total;
            document.getElementById('user30DayAvg').textContent = analytics.avg30Day;
            document.getElementById('userWeeklyRate').textContent = analytics.weeklyRate;
            
            document.getElementById('userLast7Days').textContent = analytics.last7Days;
            document.getElementById('userLast30Days').textContent = analytics.last30Days;
            document.getElementById('userBatchAverage').textContent = analytics.batchAvg;
            
            const diffEl = document.getElementById('userDifference');
            const diff = analytics.difference;
            diffEl.textContent = (diff >= 0 ? '+' : '') + diff;
            diffEl.className = 'text-2xl font-bold ' + (diff >= 0 ? 'text-green-700' : 'text-red-700');
            
            // Create progress chart
            if (userProgressChart) userProgressChart.destroy();
            const ctx1 = document.getElementById('userProgressChart').getContext('2d');
            
            // Generate 30 days of mock data
            const days = [];
            const sectors = [];
            let cumulative = 0;
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }));
                const dailySectors = Math.floor(Math.random() * 3); // Random 0-2 sectors per day
                cumulative += dailySectors;
                sectors.push(cumulative);
            }
            
            userProgressChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'Cumulative Sectors',
                        data: sectors,
                        borderColor: 'rgb(99, 102, 241)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Create batch comparison chart
            if (userBatchChart) userBatchChart.destroy();
            const ctx2 = document.getElementById('userBatchChart').getContext('2d');
            
            const batchCadets = cadets.filter(c => c.batch === cadet.batch);
            const topPerformers = batchCadets
                .sort((a, b) => (b.sectorsFlown || 0) - (a.sectorsFlown || 0))
                .slice(0, 10);
            
            userBatchChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: topPerformers.map((c, i) => c.id === cadet.id ? `YOU (${c.name.split(' ')[0]})` : c.name.split(' ')[0]),
                    datasets: [{
                        label: 'Sectors Flown',
                        data: topPerformers.map(c => c.sectorsFlown || 0),
                        backgroundColor: topPerformers.map(c => 
                            c.id === cadet.id ? 'rgba(99, 102, 241, 0.8)' : 'rgba(156, 163, 175, 0.6)'
                        ),
                        borderColor: topPerformers.map(c => 
                            c.id === cadet.id ? 'rgb(99, 102, 241)' : 'rgb(156, 163, 175)'
                        ),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
        }

        function updateAdminAnalytics(selectedBatch = 'all') {
            let filteredCadets = selectedBatch === 'all' ? cadets : cadets.filter(c => c.batch === selectedBatch);
            
            if (filteredCadets.length === 0) {
                document.getElementById('analyticsTotalTrainees').textContent = '0';
                document.getElementById('analyticsTotalSectors').textContent = '0';
                document.getElementById('analyticsAvgSectors').textContent = '0';
                document.getElementById('analyticsTopPerformer').textContent = '-';
                return;
            }
            
            const totalSectors = filteredCadets.reduce((sum, c) => sum + (c.sectorsFlown || 0), 0);
            const avgSectors = Math.round(totalSectors / filteredCadets.length);
            const topPerformer = [...filteredCadets].sort((a, b) => (b.sectorsFlown || 0) - (a.sectorsFlown || 0))[0];
            
            document.getElementById('analyticsTotalTrainees').textContent = filteredCadets.length;
            document.getElementById('analyticsTotalSectors').textContent = totalSectors;
            document.getElementById('analyticsAvgSectors').textContent = avgSectors;
            document.getElementById('analyticsTopPerformer').textContent = topPerformer.name.split(' ')[0];
            
            // Distribution chart
            if (adminDistributionChart) adminDistributionChart.destroy();
            const ctx1 = document.getElementById('adminDistributionChart').getContext('2d');
            
            const ranges = ['0-50', '51-100', '101-150', '151-200', '200+'];
            const distribution = [0, 0, 0, 0, 0];
            filteredCadets.forEach(c => {
                const sectors = c.sectorsFlown || 0;
                if (sectors <= 50) distribution[0]++;
                else if (sectors <= 100) distribution[1]++;
                else if (sectors <= 150) distribution[2]++;
                else if (sectors <= 200) distribution[3]++;
                else distribution[4]++;
            });
            
            adminDistributionChart = new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ranges,
                    datasets: [{
                        data: distribution,
                        backgroundColor: [
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(168, 85, 247, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right' }
                    }
                }
            });
            
            // Top 10 chart
            if (adminTop10Chart) adminTop10Chart.destroy();
            const ctx2 = document.getElementById('adminTop10Chart').getContext('2d');
            
            const top10 = [...filteredCadets]
                .sort((a, b) => (b.sectorsFlown || 0) - (a.sectorsFlown || 0))
                .slice(0, 10);
            
            adminTop10Chart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: top10.map(c => c.name.split(' ')[0]),
                    datasets: [{
                        label: 'Sectors',
                        data: top10.map(c => c.sectorsFlown || 0),
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderColor: 'rgb(99, 102, 241)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { beginAtZero: true }
                    }
                }
            });
            
            // Leaderboard
            const leaderboard = [...filteredCadets]
                .sort((a, b) => (b.sectorsFlown || 0) - (a.sectorsFlown || 0));
            
            const tbody = document.getElementById('analyticsLeaderboard');
            tbody.innerHTML = leaderboard.map((c, i) => {
                const diff = (c.sectorsFlown || 0) - avgSectors;
                const diffClass = diff >= 0 ? 'text-green-700' : 'text-red-700';
                const medal = i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '';
                
                return `
                    <tr class="${i < 3 ? 'bg-yellow-50' : 'hover:bg-gray-50'}">
                        <td class="px-6 py-3 text-sm font-bold">${medal} ${i + 1}</td>
                        <td class="px-6 py-3 text-sm">${c.name}</td>
                        <td class="px-6 py-3 text-sm">${c.batch}</td>
                        <td class="px-6 py-3 text-sm font-bold">${c.sectorsFlown || 0}</td>
                        <td class="px-6 py-3 text-sm font-bold ${diffClass}">${diff >= 0 ? '+' : ''}${diff}</td>
                    </tr>
                `;
            }).join('');
        }

        function gapiLoaded() {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: CONFIG.API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                });
                gapiInited = true;
                maybeEnableButtons();
            });
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                callback: (resp) => {
                    if (resp.error !== undefined) {
                        alert('Error accessing Google Sheets');
                        return;
                    }
                    accessToken = resp.access_token;
                    loadFromSheets();
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                const container = document.getElementById('g_id_signin');
                if (!container) return;
                
                try {
                    google.accounts.id.initialize({
                        client_id: CONFIG.CLIENT_ID,
                        callback: handleCredentialResponse,
                        auto_select: false,
                        cancel_on_tap_outside: false
                    });
                    
                    google.accounts.id.renderButton(container, { 
                        theme: 'outline', 
                        size: 'large',
                        width: 400
                    });
                } catch (error) {
                    console.error('Error:', error);
                }
            }
        }

        function handleCredentialResponse(response) {
            try {
                const payload = parseJwt(response.credential);
                if (!payload) throw new Error('Failed to parse');
                
                currentUser = {
                    email: payload.email,
                    name: payload.name,
                    picture: payload.picture
                };
                
                // OPTIONAL: Restrict access to specific email domains
                // Uncomment and modify the lines below to enable domain restriction
                /*
                const allowedDomains = ['malaysiaairlines.com', 'mas.com.my']; // Add your domains
                const emailDomain = currentUser.email.split('@')[1];
                if (!allowedDomains.includes(emailDomain.toLowerCase())) {
                    alert('‚ùå Access Denied\n\nOnly company email addresses are allowed.\n\nYour email: ' + currentUser.email);
                    location.reload();
                    return;
                }
                */
                
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('signInScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                if (accessToken === null) {
                    tokenClient.requestAccessToken({prompt: 'consent'});
                } else {
                    tokenClient.requestAccessToken({prompt: ''});
                }
            } catch (error) {
                alert('Error signing in');
            }
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(
                    atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
                );
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        async function loadFromSheets() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.SHEET_NAME}!A2:M`,
                });

                const rows = response.result.values || [];
                
                cadets = rows.map((row, index) => ({
                    id: index + 1,
                    batch: (row[0] || '').toString().trim().toUpperCase(),
                    staffId: (row[1] || '').toString().trim().toUpperCase(),
                    rank: (row[2] || '').toString().trim().toUpperCase(),
                    name: (row[3] || '').toString().trim().toUpperCase(),
                    firstIOEDate: row[4] || '',
                    functionalDate: row[5] || '',
                    lrcDate: row[6] || '',
                    interviewDate: row[7] || '',
                    sectorsFlown: parseInt(row[8]) || 0,
                    lastUpdated: row[9] || '',
                    remarks: (row[10] || '').toString().trim().toUpperCase(),
                    manualHighlight: row[11] || null,
                    sectorHistory: JSON.parse(row[12] || '[]')
                }));

                batches = [...new Set(cadets.map(c => c.batch).filter(b => b))].sort();
                
                updateBatchDropdowns();
                updateExportFilterNotice();
                updateAdminTable();
                updateStats();
            } catch (error) {
                console.error('Error loading:', error);
                alert('Error loading data');
            }
        }

        async function saveToSheets() {
            try {
                const values = cadets.map(c => [
                    c.batch, c.staffId, c.rank, c.name,
                    c.firstIOEDate, c.functionalDate, c.lrcDate, c.interviewDate,
                    c.sectorsFlown, c.lastUpdated, c.remarks,
                    c.manualHighlight || '', JSON.stringify(c.sectorHistory || [])
                ]);

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: `${CONFIG.SHEET_NAME}!A2:M`,
                    valueInputOption: 'RAW',
                    resource: { values: values }
                });
            } catch (error) {
                console.error('Error saving:', error);
                alert('Error saving data');
            }
        }

        function tryInitialize() {
            const gapiReady = typeof gapi !== 'undefined';
            const googleReady = typeof google !== 'undefined' && typeof google.accounts !== 'undefined';
            
            if (gapiReady && googleReady) {
                gapiLoaded();
                gisLoaded();
            } else {
                setTimeout(tryInitialize, 500);
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => setTimeout(tryInitialize, 500));
        } else {
            setTimeout(tryInitialize, 500);
        }

        document.getElementById('signOutBtn')?.addEventListener('click', () => {
            if (google?.accounts?.id) google.accounts.id.disableAutoSelect();
            location.reload();
        });

        document.getElementById('cadetViewBtn').addEventListener('click', () => switchView('cadet'));
        document.getElementById('adminViewBtn').addEventListener('click', () => switchView('admin'));

        function switchView(view) {
            currentView = view;
            if (view === 'cadet') {
                document.getElementById('cadetView').classList.remove('hidden');
                document.getElementById('adminView').classList.add('hidden');
                document.getElementById('cadetViewBtn').className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-all duration-200 bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-md hover:shadow-lg';
                document.getElementById('adminViewBtn').className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200';
            } else {
                document.getElementById('cadetView').classList.add('hidden');
                document.getElementById('adminView').classList.remove('hidden');
                document.getElementById('cadetViewBtn').className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200';
                document.getElementById('adminViewBtn').className = 'flex-1 px-6 py-3 rounded-lg font-semibold transition-all duration-200 bg-gradient-to-r from-green-600 to-green-700 text-white shadow-md hover:shadow-lg';
                if (currentUser) {
                    document.getElementById('adminCheckEmail').textContent = currentUser.email;
                }
            }
        }

        document.getElementById('adminLoginBtn').addEventListener('click', async () => {
            const password = document.getElementById('adminPassword').value;
            
            let isPasswordValid = false;
            try {
                const passwordResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: 'AdminUsers!B1',
                });
                const storedPassword = passwordResponse.result.values?.[0]?.[0];
                isPasswordValid = password === storedPassword;
            } catch (error) {}
            
            let isEmailAuthorized = false;
            try {
                const emailResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: 'AdminUsers!A:A',
                });
                const adminEmails = emailResponse.result.values?.flat().map(e => e.toLowerCase()) || [];
                isEmailAuthorized = adminEmails.includes(currentUser.email.toLowerCase());
            } catch (error) {}
            
            if (isPasswordValid || isEmailAuthorized) {
                isAdminAuth = true;
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                document.getElementById('adminPassword').value = '';
                if (isEmailAuthorized) alert(`Welcome, ${currentUser.name}!`);
            } else {
                alert('Access Denied!\n\nCreate "AdminUsers" sheet and add your email to column A');
            }
        });

        document.getElementById('adminPassword').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('adminLoginBtn').click();
        });

        document.getElementById('loadCadetBtn').addEventListener('click', () => {
            const staffId = document.getElementById('cadetStaffId').value.trim().toUpperCase();
            if (!staffId) {
                alert('Please enter Staff ID');
                return;
            }

            const cadet = cadets.find(c => c.staffId.toUpperCase() === staffId);
            if (!cadet) {
                alert('Staff ID not found');
                return;
            }

            document.getElementById('cadetFormSection').classList.remove('hidden');
            document.getElementById('cadetNameDisplay').value = cadet.name || '';
            document.getElementById('cadetRank').value = cadet.rank || '';
            document.getElementById('cadetFirstIOE').value = ddmmyyToDatePicker(cadet.firstIOEDate);
            document.getElementById('cadetFunctional').value = ddmmyyToDatePicker(cadet.functionalDate);
            document.getElementById('cadetLRC').value = ddmmyyToDatePicker(cadet.lrcDate);
            document.getElementById('cadetInterview').value = ddmmyyToDatePicker(cadet.interviewDate);
            document.getElementById('newSectorCount').value = cadet.sectorsFlown || '';
            document.getElementById('currentSectorsValue').textContent = cadet.sectorsFlown || '0';
            document.getElementById('currentSectorsDisplay').classList.remove('hidden');

            const rankField = document.getElementById('cadetRank');
            if (cadet.rank) {
                rankField.disabled = true;
                rankField.classList.add('bg-gray-200');
            } else {
                rankField.disabled = false;
                rankField.classList.remove('bg-gray-200');
            }

            // Show analytics
            document.getElementById('analyticsSection').classList.remove('hidden');
            updateUserAnalytics(cadet);
        });

        document.getElementById('updateCadetBtn').addEventListener('click', async () => {
            const staffId = document.getElementById('cadetStaffId').value.trim().toUpperCase();
            const cadet = cadets.find(c => c.staffId.toUpperCase() === staffId);
            
            if (!cadet) {
                alert('Staff ID not found');
                return;
            }

            const newRank = document.getElementById('cadetRank').value.toUpperCase();
            if (!cadet.rank && !newRank) {
                alert('Please select rank');
                return;
            }

            if (!cadet.rank && newRank) cadet.rank = newRank;
            
            cadet.firstIOEDate = datePickerToDdmmyy(document.getElementById('cadetFirstIOE').value);
            cadet.functionalDate = datePickerToDdmmyy(document.getElementById('cadetFunctional').value);
            cadet.lrcDate = datePickerToDdmmyy(document.getElementById('cadetLRC').value);
            cadet.interviewDate = datePickerToDdmmyy(document.getElementById('cadetInterview').value);
            
            const newCountInput = document.getElementById('newSectorCount').value;
            if (newCountInput && newCountInput.trim() !== '') {
                const newCount = parseInt(newCountInput);
                if (isNaN(newCount) || newCount < 0) {
                    alert('Invalid sector count');
                    return;
                }
                if (newCount < cadet.sectorsFlown) {
                    alert(`New count cannot be less than ${cadet.sectorsFlown}`);
                    return;
                }
                cadet.sectorsFlown = newCount;
                cadet.lastUpdated = getTodayDate();
            }
            
            await saveToSheets();
            alert('Updated successfully!');
            document.getElementById('loadCadetBtn').click();
        });

        function getTodayDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = String(today.getFullYear()).slice(-2);
            return `${day}/${month}/${year}`;
        }


        // ============== AUTO-SAVE FUNCTIONALITY ==============
        function showSaveIndicator(status) {
            const indicator = document.getElementById('saveIndicator');
            const text = document.getElementById('saveIndicatorText');
            
            indicator.className = 'save-indicator ' + status;
            
            if (status === 'saving') {
                text.textContent = 'üíæ Saving...';
            } else if (status === 'saved') {
                text.textContent = '‚úÖ Saved!';
                setTimeout(() => {
                    indicator.className = 'save-indicator';
                }, 2000);
            } else if (status === 'error') {
                text.textContent = '‚ùå Save failed!';
                setTimeout(() => {
                    indicator.className = 'save-indicator';
                }, 3000);
            }
        }

        function autoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                showSaveIndicator('saving');
                saveToGoogleSheets()
                    .then(() => showSaveIndicator('saved'))
                    .catch(() => showSaveIndicator('error'));
            }, 1500); // Save 1.5 seconds after last edit
        }

        // ============== DATA VALIDATION ==============
        function validateCadetData(cadet) {
            const errors = [];
            
            // Required fields
            if (!cadet.batch || cadet.batch.trim() === '') {
                errors.push('Batch is required');
            }
            if (!cadet.staffId || cadet.staffId.trim() === '') {
                errors.push('Staff ID is required');
            }
            if (!cadet.name || cadet.name.trim() === '') {
                errors.push('Name is required');
            }
            
            // Date order validation
            const dates = {
                firstIOE: cadet.firstIOEDate,
                functional: cadet.functionalDate,
                lrc: cadet.lrcDate,
                interview: cadet.interviewDate
            };
            
            // Convert DD/MM/YYYY to Date objects for comparison
            function parseDate(dateStr) {
                if (!dateStr || dateStr.trim() === '') return null;
                const parts = dateStr.split('/');
                if (parts.length !== 3) return null;
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            
            const firstIOEDate = parseDate(dates.firstIOE);
            const functionalDate = parseDate(dates.functional);
            const lrcDate = parseDate(dates.lrc);
            const interviewDate = parseDate(dates.interview);
            
            if (firstIOEDate && functionalDate && firstIOEDate > functionalDate) {
                errors.push('First IOE date must be before Functional date');
            }
            if (functionalDate && lrcDate && functionalDate > lrcDate) {
                errors.push('Functional date must be before LRC date');
            }
            if (lrcDate && interviewDate && lrcDate > interviewDate) {
                errors.push('LRC date must be before Interview date');
            }
            
            // Sectors validation
            if (cadet.sectorsFlown && isNaN(cadet.sectorsFlown)) {
                errors.push('Sectors must be a number');
            }
            
            // Duplicate Staff ID check (excluding self)
            const duplicate = cadets.find(c => 
                c.staffId === cadet.staffId && 
                (!cadet.originalStaffId || c.staffId !== cadet.originalStaffId)
            );
            if (duplicate) {
                errors.push('Staff ID already exists: ' + cadet.staffId);
            }
            
            return errors;
        }

        function showValidationErrors(errors, fieldIds = []) {
            if (errors.length > 0) {
                // Shake the fields with errors
                fieldIds.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.classList.add('validation-error');
                        setTimeout(() => field.classList.remove('validation-error'), 500);
                    }
                });
                
                alert('‚ö†Ô∏è Validation Errors:\n\n' + errors.map((e, i) => `${i + 1}. ${e}`).join('\n'));
                return false;
            }
            return true;
        }

        // ============== CHANGE HISTORY ==============
        function recordChange(action, cadet, oldData = null) {
            const change = {
                timestamp: new Date().toISOString(),
                action: action, // 'add', 'edit', 'delete'
                user: currentUser ? currentUser.email : 'Unknown',
                cadet: { ...cadet },
                oldData: oldData
            };
            changeHistory.push(change);
            
            // Keep only last 100 changes
            if (changeHistory.length > 100) {
                changeHistory.shift();
            }
        }

        function showChangeHistory() {
            if (changeHistory.length === 0) {
                alert('No changes recorded yet.');
                return;
            }
            
            const recent = changeHistory.slice(-20).reverse();
            let message = 'üìù Recent Changes (Last 20):\n\n';
            recent.forEach(change => {
                const time = new Date(change.timestamp).toLocaleString();
                const user = change.user.split('@')[0];
                message += `${time} - ${user}\n`;
                message += `  ${change.action.toUpperCase()}: ${change.cadet.name} (${change.cadet.staffId})\n\n`;
            });
            
            alert(message);
        }

        // ============== SORTING FUNCTIONALITY ==============
        function sortCadets(column) {
            // Toggle direction if clicking same column
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            cadets.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];
                
                // Handle empty values
                if (!aVal) aVal = '';
                if (!bVal) bVal = '';
                
                // Special handling for numbers
                if (column === 'sectorsFlown') {
                    aVal = parseInt(aVal) || 0;
                    bVal = parseInt(bVal) || 0;
                }
                
                // Special handling for dates
                if (column === 'lastUpdated' || column.includes('Date')) {
                    aVal = new Date(aVal || 0).getTime();
                    bVal = new Date(bVal || 0).getTime();
                }
                
                // String comparison
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    aVal = aVal.toUpperCase();
                    bVal = bVal.toUpperCase();
                }
                
                let result = aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                return currentSort.direction === 'asc' ? result : -result;
            });
            
            updateAdminTable();
            updateSortIndicators();
        }

        function updateSortIndicators() {
            // Remove all sort classes
            document.querySelectorAll('.sortable-header').forEach(header => {
                header.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Add class to current sorted column
            if (currentSort.column) {
                const header = document.querySelector(`[data-sort="${currentSort.column}"]`)?.parentElement;
                if (header) {
                    header.classList.add('sort-' + currentSort.direction);
                }
            }
        }

        // ============== COPY TO CLIPBOARD ==============
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ';
                button.classList.add('copy-success');
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('copy-success');
                }, 1000);
            }).catch(err => {
                console.error('Copy failed:', err);
                alert('Failed to copy to clipboard');
            });
        }

        // ============== BULK IMPORT ==============
        let bulkImportData = null;

        function processBulkImportFile() {
            const file = document.getElementById('bulkImportFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                if (jsonData.length === 0) {
                    alert('No data found in Excel file!');
                    return;
                }
                
                // Convert to cadet format
                bulkImportData = jsonData.map(row => ({
                    batch: (row.Batch || '').toString().toUpperCase(),
                    staffId: (row.Staff_ID || '').toString().toUpperCase(),
                    name: (row.Name || '').toString().toUpperCase(),
                    rank: (row.Rank || '').toString().toUpperCase(),
                    firstIOEDate: formatExcelDate(row.First_IOE_Date),
                    functionalDate: formatExcelDate(row.Functional_Date),
                    lrcDate: formatExcelDate(row.LRC_Date),
                    interviewDate: formatExcelDate(row.Interview_Date),
                    sectorsFlown: parseInt(row.Sectors_Flown) || 0,
                    remarks: (row.Remarks || '').toString(),
                    manualHighlight: '',
                    lastUpdated: new Date().toISOString()
                }));
                
                // Show preview
                showBulkImportPreview();
                document.getElementById('processBulkImportBtn').disabled = false;
            };
            reader.readAsArrayBuffer(file);
        }

        function formatExcelDate(excelDate) {
            if (!excelDate) return '';
            
            // If already in DD/MM/YYYY format
            if (typeof excelDate === 'string' && excelDate.includes('/')) {
                return excelDate;
            }
            
            // If Excel date number
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - 25569) * 86400 * 1000);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            
            return '';
        }

        function showBulkImportPreview() {
            const preview = document.getElementById('bulkImportPreview');
            const content = document.getElementById('bulkImportPreviewContent');
            
            let html = `<p class="font-semibold mb-2">Found ${bulkImportData.length} trainees:</p>`;
            html += '<table class="w-full text-xs"><thead><tr class="bg-gray-100">';
            html += '<th class="p-1 text-left">Batch</th><th class="p-1 text-left">Staff ID</th><th class="p-1 text-left">Name</th></tr></thead><tbody>';
            
            bulkImportData.slice(0, 10).forEach(cadet => {
                html += `<tr><td class="p-1">${cadet.batch}</td><td class="p-1">${cadet.staffId}</td><td class="p-1">${cadet.name}</td></tr>`;
            });
            
            if (bulkImportData.length > 10) {
                html += `<tr><td colspan="3" class="p-1 text-gray-500 italic">...and ${bulkImportData.length - 10} more</td></tr>`;
            }
            
            html += '</tbody></table>';
            content.innerHTML = html;
            preview.classList.remove('hidden');
        }

        async function executeBulkImport() {
            if (!bulkImportData || bulkImportData.length === 0) return;
            
            // Validate all records
            const allErrors = [];
            bulkImportData.forEach((cadet, idx) => {
                const errors = validateCadetData(cadet);
                if (errors.length > 0) {
                    allErrors.push(`Row ${idx + 2}: ${errors.join(', ')}`);
                }
            });
            
            if (allErrors.length > 0) {
                alert('‚ùå Validation Errors:\n\n' + allErrors.slice(0, 10).join('\n') + 
                      (allErrors.length > 10 ? `\n...and ${allErrors.length - 10} more errors` : ''));
                return;
            }
            
            // Confirm import
            if (!confirm(`Import ${bulkImportData.length} trainees?\n\nThis will add them to the database.`)) {
                return;
            }
            
            showSaveIndicator('saving');
            
            // Add all to cadets array
            bulkImportData.forEach(cadet => {
                cadets.push(cadet);
                recordChange('add', cadet);
            });
            
            // Save to Google Sheets
            try {
                await saveToGoogleSheets();
                showSaveIndicator('saved');
                alert(`‚úÖ Successfully imported ${bulkImportData.length} trainees!`);
                
                // Close modal and refresh
                document.getElementById('bulkImportModal').classList.add('hidden');
                document.getElementById('bulkImportFile').value = '';
                document.getElementById('bulkImportPreview').classList.add('hidden');
                bulkImportData = null;
                document.getElementById('processBulkImportBtn').disabled = true;
                
                loadData();
            } catch (error) {
                showSaveIndicator('error');
                alert('‚ùå Failed to save to Google Sheets!\n\n' + error.message);
            }
        }

        // ============== CONFIRMATION DIALOGS ==============
        function confirmDelete(cadetName) {
            return confirm(`‚ö†Ô∏è Delete Trainee?\n\n${cadetName}\n\nThis action cannot be undone!`);
        }

        function confirmBulkDelete(count) {
            return confirm(`‚ö†Ô∏è Delete ${count} Trainees?\n\nThis action cannot be undone!`);
        }
        function getYearFromBatch(batchName) {
            if (!batchName) return null;
            const match = batchName.match(/^(\d{2})/);
            if (match) {
                const yearShort = parseInt(match[1]);
                return 2000 + yearShort;
            }
            return null;
        }

        function updateBatchDropdowns() {
            const batchFilter = document.getElementById('batchFilter');
            batchFilter.innerHTML = '<option value="all">All Batches</option>' + 
                batches.map(b => `<option value="${b}">${b}</option>`).join('');

            const years = [...new Set(cadets.map(c => getYearFromBatch(c.batch)).filter(y => y !== null))].sort((a, b) => b - a);
            const yearFilter = document.getElementById('yearFilter');
            yearFilter.innerHTML = '<option value="all">All Years</option>' + 
                years.map(y => `<option value="${y}">${y}</option>`).join('');

            const newCadetBatch = document.getElementById('newCadetBatch');
            newCadetBatch.innerHTML = '<option value="">Select...</option>' + 
                batches.map(b => `<option value="${b}">${b}</option>`).join('');

            // Update analytics batch selector
            const analyticsBatchSelect = document.getElementById('analyticsBatchSelect');
            if (analyticsBatchSelect) {
                analyticsBatchSelect.innerHTML = '<option value="all">All Batches Combined</option>' + 
                    batches.map(b => `<option value="${b}">${b}</option>`).join('');
            }
        }

        function updateBatchFilterByYear() {
            const batchFilter = document.getElementById('batchFilter');
            const currentBatchValue = batchFilter.value;
            
            if (selectedYearFilter === 'all') {
                batchFilter.innerHTML = '<option value="all">All Batches</option>' + 
                    batches.map(b => `<option value="${b}">${b}</option>`).join('');
            } else {
                const filteredBatches = batches.filter(batch => {
                    const batchYear = getYearFromBatch(batch);
                    return batchYear === parseInt(selectedYearFilter);
                });
                
                batchFilter.innerHTML = '<option value="all">All (' + selectedYearFilter + ')</option>' + 
                    filteredBatches.map(b => `<option value="${b}">${b}</option>`).join('');
                
                if (currentBatchValue !== 'all' && !filteredBatches.includes(currentBatchValue)) {
                    selectedBatchFilter = 'all';
                    batchFilter.value = 'all';
                } else {
                    batchFilter.value = currentBatchValue;
                }
            }
            
            updateExportFilterNotice();
        }

        function updateExportFilterNotice() {
            const notice = document.getElementById('exportFilterNotice');
            const hasFilters = selectedYearFilter !== 'all' || selectedBatchFilter !== 'all' || 
                              selectedRankFilter !== 'all' || selectedStatusFilter !== 'all' || 
                              selectedUpdateFilter !== 'all' || searchQuery !== '';
            
            if (hasFilters) {
                notice.classList.remove('hidden');
            } else {
                notice.classList.add('hidden');
            }
        }

        document.getElementById('yearFilter').addEventListener('change', (e) => {
            selectedYearFilter = e.target.value;
            currentPage = 1;
            updateBatchFilterByYear();
            updateAdminTable();
            updateStats();
        });

        document.getElementById('batchFilter').addEventListener('change', (e) => {
            selectedBatchFilter = e.target.value;
            currentPage = 1;
            updateExportFilterNotice();
            updateAdminTable();
            updateStats();
        });

        document.getElementById('rankFilter').addEventListener('change', (e) => {
            selectedRankFilter = e.target.value;
            currentPage = 1;
            updateExportFilterNotice();
            updateAdminTable();
            updateStats();
        });

        document.getElementById('statusFilter').addEventListener('change', (e) => {
            selectedStatusFilter = e.target.value;
            currentPage = 1;
            updateExportFilterNotice();
            updateAdminTable();
            updateStats();
        });

        document.getElementById('updateFilter').addEventListener('change', (e) => {
            selectedUpdateFilter = e.target.value;
            currentPage = 1;
            updateExportFilterNotice();
            updateAdminTable();
            updateStats();
        });

        document.getElementById('searchBox').addEventListener('input', (e) => {
            searchQuery = e.target.value.trim().toUpperCase();
            currentPage = 1;
            updateExportFilterNotice();
            updateAdminTable();
            updateStats();
        });

        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            selectedYearFilter = 'all';
            selectedBatchFilter = 'all';
            selectedRankFilter = 'all';
            selectedStatusFilter = 'all';
            selectedUpdateFilter = 'all';
            searchQuery = '';
            
            document.getElementById('yearFilter').value = 'all';
            document.getElementById('batchFilter').value = 'all';
            document.getElementById('rankFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('updateFilter').value = 'all';
            document.getElementById('searchBox').value = '';
            
            updateBatchFilterByYear();
            updateAdminTable();
            updateStats();
            
            // Reset hide completed toggle
            if (hideCompleted) {
                document.getElementById("toggleCompletedBtn").click();
            }
        });

        // Toggle completed trainees
        document.getElementById('toggleCompletedBtn')?.addEventListener('click', () => {
            hideCompleted = !hideCompleted;
            const btn = document.getElementById('toggleCompletedBtn');
            if (hideCompleted) {
                btn.innerHTML = 'üëÅÔ∏è Show Completed';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-gray-600', 'hover:bg-gray-700');
            } else {
                btn.innerHTML = 'üëÅÔ∏è Hide Completed';
                btn.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
            updateAdminTable();
        });

        // Sortable headers
        document.querySelectorAll('.sortable-header').forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.querySelector('[data-sort]')?.getAttribute('data-sort');
                if (sortKey) {
                    sortCadets(sortKey);
                }
            });
        });

        // Bulk import
        document.getElementById('bulkImportBtn')?.addEventListener('click', () => {
            document.getElementById('bulkImportModal').classList.remove('hidden');
        });

        document.getElementById('cancelBulkImportBtn')?.addEventListener('click', () => {
            document.getElementById('bulkImportModal').classList.add('hidden');
            document.getElementById('bulkImportFile').value = '';
            document.getElementById('bulkImportPreview').classList.add('hidden');
            bulkImportData = null;
            document.getElementById('processBulkImportBtn').disabled = true;
        });

        document.getElementById('bulkImportFile')?.addEventListener('change', processBulkImportFile);
        
        document.getElementById('processBulkImportBtn')?.addEventListener('click', executeBulkImport);


        document.getElementById('rowsPerPage').addEventListener('change', (e) => {
            rowsPerPage = e.target.value;
            currentPage = 1;
            updateAdminTable();
        });

        document.getElementById('prevPageBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateAdminTable();
                document.querySelector('.desktop-table').scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        document.getElementById('nextPageBtn').addEventListener('click', () => {
            const itemsPerPage = parseInt(rowsPerPage);
            const totalCadets = cadets.filter(cadet => {
                if (selectedYearFilter !== 'all') {
                    const cadetYear = getYearFromBatch(cadet.batch);
                    if (cadetYear !== parseInt(selectedYearFilter)) return false;
                }
                if (selectedBatchFilter !== 'all' && cadet.batch.trim().toLowerCase() !== selectedBatchFilter.trim().toLowerCase()) return false;
                if (selectedRankFilter !== 'all' && cadet.rank.toUpperCase() !== selectedRankFilter) return false;
                if (searchQuery && !cadet.name.toUpperCase().includes(searchQuery) && !cadet.staffId.toUpperCase().includes(searchQuery)) return false;
                return true;
            }).length;
            const totalPages = Math.ceil(totalCadets / itemsPerPage);
            
            if (currentPage < totalPages) {
                currentPage++;
                updateAdminTable();
                document.querySelector('.desktop-table').scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        document.getElementById('viewAnalyticsBtn')?.addEventListener('click', () => {
            document.getElementById('adminMainContent').classList.add('hidden');
            document.getElementById('adminAnalyticsDashboard').classList.remove('hidden');
            updateAdminAnalytics('all');
        
        document.getElementById("viewHistoryBtn")?.addEventListener("click", showChangeHistory);
        });

        document.getElementById('closeAnalyticsBtn')?.addEventListener('click', () => {
            document.getElementById('adminAnalyticsDashboard').classList.add('hidden');
            document.getElementById('adminMainContent').classList.remove('hidden');
        });

        document.getElementById('analyticsBatchSelect')?.addEventListener('change', (e) => {
            updateAdminAnalytics(e.target.value);
        });

        function updateAdminTable() {
            const tbody = document.getElementById('cadetTableBody');
            const mobileContainer = document.getElementById('mobileCardsContainer');
            
            let filteredCadets = cadets.filter(cadet => {
                // Hide completed trainees if toggle is active
                if (hideCompleted) {
                    const status = getTraineeStatus(cadet);
                    if (status === "completed") return false;
                }

                if (selectedYearFilter !== 'all') {
                    const cadetYear = getYearFromBatch(cadet.batch);
                    if (cadetYear !== parseInt(selectedYearFilter)) return false;
                }
                if (selectedBatchFilter !== 'all' && cadet.batch.trim().toLowerCase() !== selectedBatchFilter.trim().toLowerCase()) return false;
                if (selectedRankFilter !== 'all' && cadet.rank.toUpperCase() !== selectedRankFilter) return false;
                if (searchQuery && !cadet.name.toUpperCase().includes(searchQuery) && !cadet.staffId.toUpperCase().includes(searchQuery)) return false;
                return true;
            });

            filteredCadets.sort((a, b) => {
                const batchCompare = a.batch.localeCompare(b.batch);
                if (batchCompare !== 0) return batchCompare;
                return a.name.localeCompare(b.name);
            });

            const totalCadets = filteredCadets.length;
            let paginatedCadets = filteredCadets;
            
            if (rowsPerPage !== 'all') {
                const itemsPerPage = parseInt(rowsPerPage);
                const totalPages = Math.ceil(totalCadets / itemsPerPage);
                
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;
                
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                paginatedCadets = filteredCadets.slice(startIndex, endIndex);
                
                document.getElementById('pageNavigation').classList.remove('hidden');
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prevPageBtn').disabled = currentPage === 1;
                document.getElementById('nextPageBtn').disabled = currentPage === totalPages;
            } else {
                document.getElementById('pageNavigation').classList.add('hidden');
            }

            if (paginatedCadets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="text-center py-16">No trainees found</td></tr>';
                mobileContainer.innerHTML = '<div class="text-center py-16">No trainees found</div>';
                return;
            }

            let rowsHTML = '';
            let currentBatch = '';

            paginatedCadets.forEach((cadet) => {
                if (cadet.batch !== currentBatch) {
                    currentBatch = cadet.batch;
                    rowsHTML += `<tr class="bg-gray-200"><td colspan="12" class="px-4 py-3 font-bold">üìã ${cadet.batch}</td></tr>`;
                }

                let rowClass = 'hover:bg-gray-50';
                let highlightReason = 'None';
                
                if (cadet.manualHighlight === 'blue') {
                    rowClass = 'bg-blue-50 hover:bg-blue-100';
                    highlightReason = 'Manual Blue';
                } else if (cadet.manualHighlight === 'green') {
                    rowClass = 'bg-green-50 hover:bg-green-100';
                    highlightReason = 'Manual Green';
                } else if (cadet.manualHighlight === 'red') {
                    rowClass = 'bg-red-50 hover:bg-red-100';
                    highlightReason = 'Manual Red';
                } else if (!cadet.manualHighlight) {
                    const hasFirstIOE = cadet.firstIOEDate && cadet.firstIOEDate.trim() !== '';
                    const hasFunctional = cadet.functionalDate && cadet.functionalDate.trim() !== '';
                    const hasLRC = cadet.lrcDate && cadet.lrcDate.trim() !== '';
                    const hasInterview = cadet.interviewDate && cadet.interviewDate.trim() !== '';
                    
                    if (hasFirstIOE && hasFunctional && hasLRC && hasInterview) {
                        rowClass = 'bg-green-50 hover:bg-green-100';
                        highlightReason = 'Auto Green (All dates)';
                    } else if (hasFirstIOE && hasFunctional && !hasLRC && !hasInterview) {
                        rowClass = 'bg-blue-50 hover:bg-blue-100';
                        highlightReason = 'Auto Blue (IOE+Func)';
                    }
                }

                rowsHTML += `
                <tr class="${rowClass}" data-highlight="${highlightReason}">
                    <td class="px-2 py-3 text-xs">${cadet.batch}</td>
                    <td class="px-2 py-3 text-xs font-semibold">${cadet.staffId}<button onclick="copyToClipboard('${cadet.staffId}', this)" class="copy-btn text-gray-400 hover:text-blue-600 text-xs ml-1" title="Copy">üìã</button></td>
                    <td class="px-2 py-3 text-xs">${cadet.rank || '-'}</td>
                    <td class="px-3 py-3 text-xs font-semibold">${cadet.name}</td>
                    <td class="px-2 py-3 text-xs">${cadet.firstIOEDate || '-'}</td>
                    <td class="px-2 py-3 text-xs">${cadet.functionalDate || '-'}</td>
                    <td class="px-2 py-3 text-xs">${cadet.lrcDate || '-'}</td>
                    <td class="px-2 py-3 text-xs">${cadet.interviewDate || '-'}</td>
                    <td class="px-2 py-3 text-xs font-bold">${cadet.sectorsFlown}</td>
                    <td class="px-2 py-3 text-xs">${cadet.lastUpdated || '-'}</td>
                    <td class="px-2 py-3 text-xs" onclick="editRemarks(${cadet.id})" style="cursor: pointer; max-width: 150px;" title="Click to edit: ${cadet.remarks || 'No remarks'}">
                        <span id="remarks-${cadet.id}" class="block truncate text-gray-700">${cadet.remarks || '(click to add)'}</span>
                    </td>
                    <td class="px-2 py-3 sticky right-0 shadow-lg" style="background: inherit;">
                        <div class="flex gap-1 flex-wrap">
                            <button onclick="editTraineeData(${cadet.id})" class="px-2 py-1 bg-yellow-200 rounded text-xs hover:bg-yellow-300" title="Edit Data">‚úèÔ∏è</button>
                            <button onclick="setHighlight(${cadet.id}, 'blue')" class="px-2 py-1 bg-blue-200 rounded text-xs hover:bg-blue-300" title="Set Blue">üîµ</button>
                            <button onclick="setHighlight(${cadet.id}, 'green')" class="px-2 py-1 bg-green-200 rounded text-xs hover:bg-green-300" title="Set Green">üü¢</button>
                            <button onclick="setHighlight(${cadet.id}, 'red')" class="px-2 py-1 bg-red-200 rounded text-xs hover:bg-red-300" title="Set Red">üî¥</button>
                            <button onclick="setHighlight(${cadet.id}, null)" class="px-2 py-1 bg-gray-200 rounded text-xs hover:bg-gray-300" title="Clear">‚ö™</button>
                            <button onclick="deleteCadet(${cadet.id})" class="text-red-600 hover:text-red-800 px-2" title="Delete">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>`;
            });

            tbody.innerHTML = rowsHTML;
            
            let mobileHTML = '';
            filteredCadets.forEach((cadet) => {
                let cardClass = 'mobile-card';
                
                if (cadet.manualHighlight === 'blue') {
                    cardClass = 'mobile-card highlight-blue';
                } else if (cadet.manualHighlight === 'green') {
                    cardClass = 'mobile-card highlight-green';
                } else if (cadet.manualHighlight === 'red') {
                    cardClass = 'mobile-card highlight-red';
                } else if (!cadet.manualHighlight) {
                    const hasFirstIOE = cadet.firstIOEDate && cadet.firstIOEDate.trim() !== '';
                    const hasFunctional = cadet.functionalDate && cadet.functionalDate.trim() !== '';
                    const hasLRC = cadet.lrcDate && cadet.lrcDate.trim() !== '';
                    const hasInterview = cadet.interviewDate && cadet.interviewDate.trim() !== '';
                    
                    if (hasFirstIOE && hasFunctional && hasLRC && hasInterview) {
                        cardClass = 'mobile-card highlight-green';
                    } else if (hasFirstIOE && hasFunctional && !hasLRC && !hasInterview) {
                        cardClass = 'mobile-card highlight-blue';
                    }
                }
                
                mobileHTML += `
                    <div class="${cardClass}">
                        <div class="font-bold text-lg mb-2">${cadet.name}</div>
                        <div class="text-sm text-gray-600 mb-2">${cadet.staffId} - ${cadet.rank || 'No Rank'}</div>
                        <div class="text-sm mb-2">Batch: ${cadet.batch}</div>
                        <div class="text-sm mb-2">Sectors: <span class="font-bold">${cadet.sectorsFlown}</span></div>
                        ${cadet.remarks ? `<div class="text-xs text-gray-600 italic mb-2">üí¨ ${cadet.remarks}</div>` : ''}
                        <div class="flex gap-1 mt-2">
                            <button onclick="editTraineeData(${cadet.id})" class="px-2 py-1 bg-yellow-200 rounded text-xs">‚úèÔ∏è</button>
                            <button onclick="setHighlight(${cadet.id}, 'blue')" class="px-2 py-1 bg-blue-200 rounded text-xs">üîµ</button>
                            <button onclick="setHighlight(${cadet.id}, 'green')" class="px-2 py-1 bg-green-200 rounded text-xs">üü¢</button>
                            <button onclick="setHighlight(${cadet.id}, 'red')" class="px-2 py-1 bg-red-200 rounded text-xs">üî¥</button>
                            <button onclick="setHighlight(${cadet.id}, null)" class="px-2 py-1 bg-gray-200 rounded text-xs">‚ö™</button>
                            <button onclick="deleteCadet(${cadet.id})" class="text-red-600 px-2">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            });
            
            mobileContainer.innerHTML = mobileHTML || '<div class="text-center py-8">No trainees found</div>';
            
            // Enhanced filter count display
            const activeFilters = [];
            if (hideCompleted) activeFilters.push('üëÅÔ∏è Hiding Completed');
            if (selectedYearFilter !== 'all') activeFilters.push(`üìÖ ${selectedYearFilter}`);
            if (selectedBatchFilter !== 'all') activeFilters.push(`üìã ${selectedBatchFilter}`);
            if (selectedRankFilter !== 'all') activeFilters.push(`‚≠ê ${selectedRankFilter}`);
            if (selectedStatusFilter !== 'all') activeFilters.push(`üìä ${selectedStatusFilter}`);
            if (searchQuery) activeFilters.push(`üîç "${searchQuery}"`);
            
            let filterText = '';
            if (rowsPerPage === 'all') {
                filterText = `<strong>${totalCadets}</strong> of <strong>${cadets.length}</strong> trainees`;
            } else {
                const startNum = (currentPage - 1) * parseInt(rowsPerPage) + 1;
                const endNum = Math.min(currentPage * parseInt(rowsPerPage), totalCadets);
                filterText = `<strong>${startNum}-${endNum}</strong> of <strong>${totalCadets}</strong> trainees`;
            }
            
            if (activeFilters.length > 0) {
                filterText += ` | ${activeFilters.join(' | ')}`;
            }
            
            document.getElementById('filterCount').innerHTML = filterText;
        }

        function updateStats() {
            const filteredCadets = cadets;
            const totalSectors = filteredCadets.reduce((sum, c) => sum + c.sectorsFlown, 0);
            const avgSectors = filteredCadets.length > 0 ? Math.round(totalSectors / filteredCadets.length) : 0;

            document.getElementById('statsCadets').textContent = filteredCadets.length;
            document.getElementById('statsSectors').textContent = totalSectors;
            document.getElementById('statsAvg').textContent = avgSectors;
        }

        async function setHighlight(id, color) {
            const cadet = cadets.find(c => c.id === id);
            if (!cadet) return;
            
            cadet.manualHighlight = color;
            updateAdminTable();
            await saveToSheets();
            
            const colorName = color === 'blue' ? 'Blue (Functional)' : 
                             color === 'green' ? 'Green (Completed)' : 
                             color === 'red' ? 'Red (Special Case)' : 
                             'None (Auto)';
            console.log(`‚úÖ Highlight set to ${colorName} for ${cadet.name}`);
        }

        async function deleteCadet(id) {
            const cadet = cadets.find(c => c.id === id);
            if (!cadet) return;
            
            if (confirmDelete(cadet.name)) {
                recordChange('delete', cadet);
                cadets = cadets.filter(c => c.id !== id);
                updateAdminTable();
                updateStats();
                showSaveIndicator('saving');
                await saveToSheets();
                showSaveIndicator('saved');
            }
        }

        async function editRemarks(id) {
            const cadet = cadets.find(c => c.id === id);
            if (!cadet) return;
            
            const currentRemarks = cadet.remarks || '';
            const newRemarks = prompt(`Edit remarks for ${cadet.name}:`, currentRemarks);
            
            if (newRemarks !== null) {
                cadet.remarks = newRemarks.trim().toUpperCase();
                
                const remarksSpan = document.getElementById(`remarks-${id}`);
                if (remarksSpan) {
                    remarksSpan.textContent = cadet.remarks || '(click to add)';
                }
                
                await saveToSheets();
                console.log(`‚úÖ Remarks updated for ${cadet.name}`);
            }
        }

        let currentEditingId = null;

        function editTraineeData(id) {
            const cadet = cadets.find(c => c.id === id);
            if (!cadet) return;
            
            currentEditingId = id;
            
            document.getElementById('editModalSubtitle').textContent = `Editing: ${cadet.name}`;
            document.getElementById('editStaffId').value = cadet.staffId;
            document.getElementById('editRank').value = cadet.rank || '';
            document.getElementById('editName').value = cadet.name;
            document.getElementById('editFirstIOE').value = ddmmyyToDatePicker(cadet.firstIOEDate);
            document.getElementById('editFunctional').value = ddmmyyToDatePicker(cadet.functionalDate);
            document.getElementById('editLRC').value = ddmmyyToDatePicker(cadet.lrcDate);
            document.getElementById('editInterview').value = ddmmyyToDatePicker(cadet.interviewDate);
            document.getElementById('editSectors').value = cadet.sectorsFlown || 0;
            document.getElementById('editBatch').value = cadet.batch;
            document.getElementById('editRemarksField').value = cadet.remarks || '';
            
            document.getElementById('editTraineeModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editTraineeModal').classList.add('hidden');
            currentEditingId = null;
        }

        async function saveTraineeEdit() {
            if (!currentEditingId) return;
            
            const cadet = cadets.find(c => c.id === currentEditingId);
            if (!cadet) return;
            
            // Store old data for change history
            const oldData = { ...cadet };
            
            // Create updated cadet object
            const updatedCadet = {
                ...cadet,
                rank: document.getElementById('editRank').value.toUpperCase(),
                name: document.getElementById('editName').value.trim().toUpperCase(),
                firstIOEDate: datePickerToDdmmyy(document.getElementById('editFirstIOE').value),
                functionalDate: datePickerToDdmmyy(document.getElementById('editFunctional').value),
                lrcDate: datePickerToDdmmyy(document.getElementById('editLRC').value),
                interviewDate: datePickerToDdmmyy(document.getElementById('editInterview').value),
                sectorsFlown: parseInt(document.getElementById('editSectors').value) || 0,
                batch: document.getElementById('editBatch').value.trim().toUpperCase(),
                remarks: document.getElementById('editRemarksField').value.trim().toUpperCase(),
                lastUpdated: getTodayDate(),
                originalStaffId: cadet.staffId // For duplicate checking
            };
            
            // Validate
            const errors = validateCadetData(updatedCadet);
            const fieldIds = ['editBatch', 'editName', 'editRank', 'editFirstIOE', 'editFunctional', 'editLRC', 'editInterview', 'editSectors'];
            if (!showValidationErrors(errors, fieldIds)) {
                return;
            }
            
            // Apply updates
            Object.assign(cadet, updatedCadet);
            delete cadet.originalStaffId;
            
            if (!batches.includes(cadet.batch)) {
                batches.push(cadet.batch);
                batches.sort();
                updateBatchDropdowns();
            }
            
            recordChange('edit', cadet, oldData);
            showSaveIndicator('saving');
            
            await saveToSheets();
            showSaveIndicator('saved');
            
            updateAdminTable();
            updateStats();
            closeEditModal();
            
            alert(`‚úÖ Updated ${cadet.name}'s data successfully!`);
        }

        document.getElementById('editTraineeModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'editTraineeModal') {
                closeEditModal();
            }
        });

        document.getElementById('addCadetBtn').addEventListener('click', () => {
            const form = document.getElementById('addCadetForm');
            form.classList.toggle('hidden');
        });

        document.getElementById('cancelAddBtn').addEventListener('click', () => {
            document.getElementById('addCadetForm').classList.add('hidden');
            document.getElementById('newBatchInput').classList.add('hidden');
            document.getElementById('newBatchName').value = '';
            document.getElementById('newCadetBatch').disabled = false;
        });

        document.getElementById('toggleNewBatchBtn').addEventListener('click', () => {
            const newBatchInput = document.getElementById('newBatchInput');
            const batchSelect = document.getElementById('newCadetBatch');
            
            if (newBatchInput.classList.contains('hidden')) {
                newBatchInput.classList.remove('hidden');
                batchSelect.disabled = true;
                batchSelect.value = '';
                batchSelect.classList.add('bg-gray-100');
                document.getElementById('newBatchName').focus();
            } else {
                newBatchInput.classList.add('hidden');
                batchSelect.disabled = false;
                batchSelect.classList.remove('bg-gray-100');
                document.getElementById('newBatchName').value = '';
            }
        });

        document.getElementById('submitCadetBtn').addEventListener('click', async () => {
            const staffId = document.getElementById('newCadetStaffId').value.trim().toUpperCase();
            const rank = document.getElementById('newCadetRank').value;
            const name = document.getElementById('newCadetName').value.trim().toUpperCase();
            
            const newBatchName = document.getElementById('newBatchName').value.trim().toUpperCase();
            const selectedBatch = document.getElementById('newCadetBatch').value.toUpperCase();
            const batch = newBatchName || selectedBatch;
            
            const newId = cadets.length > 0 ? Math.max(...cadets.map(c => c.id)) + 1 : 1;
            
            const newCadet = {
                id: newId, 
                batch, 
                staffId, 
                rank, 
                name,
                firstIOEDate: datePickerToDdmmyy(document.getElementById('newCadetIOE').value),
                functionalDate: datePickerToDdmmyy(document.getElementById('newCadetFunctional').value),
                lrcDate: datePickerToDdmmyy(document.getElementById('newCadetLRC').value),
                interviewDate: datePickerToDdmmyy(document.getElementById('newCadetInterview').value),
                sectorsFlown: parseInt(document.getElementById('newCadetSectors').value) || 0,
                lastUpdated: getTodayDate(), 
                remarks: '', 
                manualHighlight: null, 
                sectorHistory: []
            };
            
            // Validate
            const errors = validateCadetData(newCadet);
            const fieldIds = ['newCadetBatch', 'newCadetStaffId', 'newCadetName', 'newCadetIOE', 'newCadetFunctional', 'newCadetLRC', 'newCadetInterview', 'newCadetSectors'];
            if (!showValidationErrors(errors, fieldIds)) {
                return;
            }
            
            cadets.push(newCadet);
            recordChange('add', newCadet);

            if (!batches.includes(batch)) {
                batches.push(batch);
                batches.sort();
                updateBatchDropdowns();
            }

            // Clear form
            document.getElementById('newCadetStaffId').value = '';
            document.getElementById('newCadetRank').value = '';
            document.getElementById('newCadetName').value = '';
            document.getElementById('newCadetBatch').value = '';
            document.getElementById('newCadetIOE').value = '';
            document.getElementById('newCadetFunctional').value = '';
            document.getElementById('newCadetLRC').value = '';
            document.getElementById('newCadetInterview').value = '';
            document.getElementById('newCadetSectors').value = '0';
            document.getElementById('newBatchName').value = '';
            document.getElementById('newBatchInput').classList.add('hidden');
            document.getElementById('newCadetBatch').disabled = false;
            document.getElementById('newCadetBatch').classList.remove('bg-gray-100');

            document.getElementById('addCadetForm').classList.add('hidden');
            updateAdminTable();
            updateStats();
            
            showSaveIndicator('saving');
            await saveToSheets();
            showSaveIndicator('saved');
            
            if (newBatchName) {
                alert(`‚úÖ Trainee "${name}" added to NEW batch "${batch}"!`);
            } else {
                alert(`‚úÖ Trainee "${name}" added!`);
            }
        });

        document.getElementById('refreshDataBtn').addEventListener('click', async () => {
            await loadFromSheets();
            updateAdminTable();
            updateStats();
            alert('‚úÖ Data refreshed!\n\nüé® Color highlights updated:\n‚Ä¢ Blue = Functional\n‚Ä¢ Green = Completed\n‚Ä¢ Red = Special Case\n‚Ä¢ White = In Progress');
        });

        document.getElementById('testHighlightsBtn').addEventListener('click', () => {
            let report = 'üé® HIGHLIGHT DEBUG REPORT\n\n';
            
            let blueCount = 0, greenCount = 0, redCount = 0, autoBlue = 0, autoGreen = 0, noHighlight = 0;
            let blueExamples = [];
            let notBlueExamples = [];
            
            cadets.forEach(cadet => {
                const hasFirstIOE = cadet.firstIOEDate && cadet.firstIOEDate.trim() !== '';
                const hasFunctional = cadet.functionalDate && cadet.functionalDate.trim() !== '';
                const hasLRC = cadet.lrcDate && cadet.lrcDate.trim() !== '';
                const hasInterview = cadet.interviewDate && cadet.interviewDate.trim() !== '';
                
                if (cadet.manualHighlight === 'blue') {
                    blueCount++;
                } else if (cadet.manualHighlight === 'green') {
                    greenCount++;
                } else if (cadet.manualHighlight === 'red') {
                    redCount++;
                } else {
                    if (hasFirstIOE && hasFunctional && hasLRC && hasInterview) {
                        autoGreen++;
                    } else if (hasFirstIOE && hasFunctional && !hasLRC && !hasInterview) {
                        autoBlue++;
                        if (blueExamples.length < 3) {
                            blueExamples.push(`${cadet.name} (IOE:${cadet.firstIOEDate}, Func:${cadet.functionalDate})`);
                        }
                    } else {
                        noHighlight++;
                        if (notBlueExamples.length < 3 && (hasFirstIOE || hasFunctional)) {
                            notBlueExamples.push(`${cadet.name} - IOE:${hasFirstIOE?'‚úì':'‚úó'} Func:${hasFunctional?'‚úì':'‚úó'} LRC:${hasLRC?'‚úì':'‚úó'} Int:${hasInterview?'‚úì':'‚úó'}`);
                        }
                    }
                }
            });
            
            report += `üìä Manual Highlights:\n`;
            report += `  üîµ Blue (Manual): ${blueCount}\n`;
            report += `  üü¢ Green (Manual): ${greenCount}\n`;
            report += `  üî¥ Red (Manual): ${redCount}\n\n`;
            
            report += `ü§ñ Auto Highlights:\n`;
            report += `  üîµ Blue (Auto): ${autoBlue}\n`;
            report += `  üü¢ Green (Auto): ${autoGreen}\n`;
            report += `  ‚ö™ No Highlight: ${noHighlight}\n\n`;
            
            if (blueExamples.length > 0) {
                report += `‚úÖ BLUE Examples (should be highlighted):\n`;
                blueExamples.forEach(ex => report += `  ‚Ä¢ ${ex}\n`);
                report += `\n`;
            }
            
            if (notBlueExamples.length > 0) {
                report += `‚ùå NOT Blue (check these):\n`;
                notBlueExamples.forEach(ex => report += `  ‚Ä¢ ${ex}\n`);
                report += `\n`;
            }
            
            report += `üìà Total: ${cadets.length} trainees\n`;
            report += `üé® Highlighted: ${blueCount + greenCount + redCount + autoBlue + autoGreen}\n\n`;
            
            report += `üîç BLUE Highlight Criteria:\n`;
            report += `  ‚úì Has First IOE date\n`;
            report += `  ‚úì Has Functional date\n`;
            report += `  ‚úó No LRC date\n`;
            report += `  ‚úó No Interview date\n\n`;
            
            report += `üí° If still not working:\n`;
            report += `  1. Check date formats (DD/MM/YY)\n`;
            report += `  2. Ensure no extra spaces\n`;
            report += `  3. Try manual blue highlight (üîµ)\n`;
            report += `  4. Check browser console (F12)`;
            
            alert(report);
            
            console.log('=== HIGHLIGHT DEBUG ===');
            console.log('Auto Blue count:', autoBlue);
            console.log('Sample trainee with dates:', cadets.find(c => c.firstIOEDate || c.functionalDate));
        });

        document.getElementById('exportExcelBtn').addEventListener('click', () => {
            if (cadets.length === 0) {
                alert('No data to export!');
                return;
            }

            const filteredCadets = cadets.filter(cadet => {
                if (selectedYearFilter !== 'all') {
                    const cadetYear = getYearFromBatch(cadet.batch);
                    if (cadetYear !== parseInt(selectedYearFilter)) return false;
                }
                if (selectedBatchFilter !== 'all' && cadet.batch.trim().toLowerCase() !== selectedBatchFilter.trim().toLowerCase()) return false;
                if (selectedRankFilter !== 'all' && cadet.rank.toUpperCase() !== selectedRankFilter) return false;
                if (selectedStatusFilter !== 'all') {
                    let cadetStatus = getTraineeStatus(cadet);
                    if (cadetStatus !== selectedStatusFilter) return false;
                }
                if (searchQuery && !cadet.name.toUpperCase().includes(searchQuery) && !cadet.staffId.toUpperCase().includes(searchQuery)) return false;
                return true;
            });

            if (filteredCadets.length === 0) {
                alert('No trainees match current filters!');
                return;
            }

            const sortedCadets = [...filteredCadets].sort((a, b) => {
                const batchCompare = a.batch.localeCompare(b.batch);
                if (batchCompare !== 0) return batchCompare;
                return a.name.localeCompare(b.name);
            });

            const formattedData = [];
            const rowMetadata = [];
            let currentBatch = '';

            sortedCadets.forEach((cadet) => {
                if (cadet.batch !== currentBatch) {
                    currentBatch = cadet.batch;
                    
                    if (formattedData.length > 0) {
                        formattedData.push({});
                        rowMetadata.push({ type: 'empty' });
                    }
                    
                    formattedData.push({
                        'Batch': `BATCH: ${cadet.batch}`,
                        'Staff ID': '', 'Rank': '', 'Name': '',
                        'First IOE': '', 'Functional': '', 'LRC': '', 'Interview': '',
                        'Sectors': '', 'Status': '', 'Last Updated': '', 'Remarks': ''
                    });
                    rowMetadata.push({ type: 'batch' });
                }

                let status = getTraineeStatusLabel(cadet);

                formattedData.push({
                    'Batch': cadet.batch,
                    'Staff ID': cadet.staffId,
                    'Rank': cadet.rank || '',
                    'Name': cadet.name,
                    'First IOE': cadet.firstIOEDate || '',
                    'Functional': cadet.functionalDate || '',
                    'LRC': cadet.lrcDate || '',
                    'Interview': cadet.interviewDate || '',
                    'Sectors': cadet.sectorsFlown,
                    'Status': status,
                    'Last Updated': cadet.lastUpdated || '',
                    'Remarks': cadet.remarks || ''
                });
                rowMetadata.push({ type: 'data', cadet: cadet });
            });

            const worksheet = XLSX.utils.json_to_sheet(formattedData);
            worksheet['!cols'] = [
                { wch: 15 }, { wch: 12 }, { wch: 8 }, { wch: 25 },
                { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 },
                { wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 30 }
            ];

            const range = XLSX.utils.decode_range(worksheet['!ref']);
            
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!worksheet[cellAddress]) continue;
                
                worksheet[cellAddress].s = {
                    font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "2563EB" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } }
                    }
                };
            }

            let coloredRows = 0;
            for (let row = 1; row <= range.e.r; row++) {
                const metadata = rowMetadata[row - 1];
                if (!metadata) continue;
                
                if (metadata.type === 'batch') {
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!worksheet[cellAddress]) worksheet[cellAddress] = { t: 's', v: '' };
                        
                        worksheet[cellAddress].s = {
                            font: { bold: true, sz: 11, color: { rgb: "FFFFFF" } },
                            fill: { fgColor: { rgb: "6366F1" } },
                            alignment: { horizontal: "left", vertical: "center" },
                            border: {
                                top: { style: "thin", color: { rgb: "000000" } },
                                bottom: { style: "thin", color: { rgb: "000000" } },
                                left: { style: "thin", color: { rgb: "000000" } },
                                right: { style: "thin", color: { rgb: "000000" } }
                            }
                        };
                    }
                } else if (metadata.type === 'data') {
                    const cadet = metadata.cadet;
                    let bgColor = "FFFFFF";
                    
                    if (cadet.manualHighlight === 'blue') {
                        bgColor = "DBEAFE";
                        coloredRows++;
                    } else if (cadet.manualHighlight === 'green') {
                        bgColor = "D1FAE5";
                        coloredRows++;
                    } else if (cadet.manualHighlight === 'red') {
                        bgColor = "FEE2E2";
                        coloredRows++;
                    } else if (!cadet.manualHighlight) {
                        const hasFirstIOE = cadet.firstIOEDate && cadet.firstIOEDate.trim() !== '';
                        const hasFunctional = cadet.functionalDate && cadet.functionalDate.trim() !== '';
                        const hasLRC = cadet.lrcDate && cadet.lrcDate.trim() !== '';
                        const hasInterview = cadet.interviewDate && cadet.interviewDate.trim() !== '';
                        
                        if (hasFirstIOE && hasFunctional && hasLRC && hasInterview) {
                            bgColor = "D1FAE5";
                            coloredRows++;
                        } else if (hasFirstIOE && hasFunctional && !hasLRC && !hasInterview) {
                            bgColor = "DBEAFE";
                            coloredRows++;
                        }
                    }
                    
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!worksheet[cellAddress]) worksheet[cellAddress] = { t: 's', v: '' };
                        
                        worksheet[cellAddress].s = {
                            fill: { fgColor: { rgb: bgColor } },
                            alignment: { horizontal: "left", vertical: "center" },
                            border: {
                                top: { style: "thin", color: { rgb: "CCCCCC" } },
                                bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                                left: { style: "thin", color: { rgb: "CCCCCC" } },
                                right: { style: "thin", color: { rgb: "CCCCCC" } }
                            }
                        };
                    }
                } else if (metadata.type === 'empty') {
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        if (!worksheet[cellAddress]) worksheet[cellAddress] = { t: 's', v: '' };
                        
                        worksheet[cellAddress].s = {
                            border: {
                                top: { style: "thin", color: { rgb: "EEEEEE" } },
                                bottom: { style: "thin", color: { rgb: "EEEEEE" } },
                                left: { style: "thin", color: { rgb: "EEEEEE" } },
                                right: { style: "thin", color: { rgb: "EEEEEE" } }
                            }
                        };
                    }
                }
            }

            worksheet['!freeze'] = { xSplit: 0, ySplit: 1 };
            worksheet['!views'] = [{ 
                state: 'frozen', 
                xSplit: 0,
                ySplit: 1, 
                topLeftCell: 'A2',
                activePane: 'bottomLeft'
            }];

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Training Data');
            
            if (!workbook.Workbook) workbook.Workbook = {};
            if (!workbook.Workbook.Views) workbook.Workbook.Views = [{}];
            workbook.Workbook.Views[0].RTL = false;
            
            const filename = `Training_Progress_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, filename, { cellStyles: true });
            
            let filterDesc = '';
            let activeFilters = [];
            if (selectedYearFilter !== 'all') activeFilters.push(`Year: ${selectedYearFilter}`);
            if (selectedBatchFilter !== 'all') activeFilters.push(`Batch: ${selectedBatchFilter}`);
            if (selectedRankFilter !== 'all') activeFilters.push(`Rank: ${selectedRankFilter}`);
            if (selectedStatusFilter !== 'all') activeFilters.push(`Status: ${selectedStatusFilter}`);
            if (searchQuery) activeFilters.push(`Search: "${searchQuery}"`);
            
            if (activeFilters.length > 0) {
                filterDesc = `\n\nüîç Filters: ${activeFilters.join(', ')}`;
            }
            
            alert(`‚úÖ Exported ${filteredCadets.length} trainees to ${filename}\n\nüé® ${coloredRows} rows colored\nüìå First row frozen for scrolling\nüìä Cell borders added${filterDesc}`);
        });

        document.getElementById('exportPowerBIBtn').addEventListener('click', () => {
            if (cadets.length === 0) {
                alert('No data to export!');
                return;
            }

            const filteredCadets = cadets.filter(cadet => {
                if (selectedYearFilter !== 'all') {
                    const cadetYear = getYearFromBatch(cadet.batch);
                    if (cadetYear !== parseInt(selectedYearFilter)) return false;
                }
                if (selectedBatchFilter !== 'all' && cadet.batch.trim().toLowerCase() !== selectedBatchFilter.trim().toLowerCase()) return false;
                if (selectedRankFilter !== 'all' && cadet.rank.toUpperCase() !== selectedRankFilter) return false;
                if (searchQuery && !cadet.name.toUpperCase().includes(searchQuery) && !cadet.staffId.toUpperCase().includes(searchQuery)) return false;
                return true;
            });

            if (filteredCadets.length === 0) {
                alert('No trainees match current filters!');
                return;
            }

            const sortedCadets = [...filteredCadets].sort((a, b) => {
                const batchCompare = a.batch.localeCompare(b.batch);
                if (batchCompare !== 0) return batchCompare;
                return a.name.localeCompare(b.name);
            });

            const cleanData = sortedCadets.map(cadet => {
                return {
                    'Batch': cadet.batch,
                    'Staff_ID': cadet.staffId,
                    'Rank': cadet.rank || '',
                    'Name': cadet.name,
                    'First_IOE_Date': cadet.firstIOEDate || '',
                    'Functional_Date': cadet.functionalDate || '',
                    'LRC_Date': cadet.lrcDate || '',
                    'Interview_Date': cadet.interviewDate || '',
                    'Sectors_Flown': cadet.sectorsFlown,
                    'Status': getTraineeStatusLabel(cadet),
                    'Last_Updated': cadet.lastUpdated || '',
                    'Remarks': cadet.remarks || ''
                };
            });

            const worksheet = XLSX.utils.json_to_sheet(cleanData);
            worksheet['!cols'] = [
                { wch: 12 }, { wch: 12 }, { wch: 8 }, { wch: 25 },
                { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 15 },
                { wch: 12 }, { wch: 15 }, { wch: 12 }, { wch: 30 }
            ];

            const range = XLSX.utils.decode_range(worksheet['!ref']);
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
                if (!worksheet[cellAddress]) continue;
                
                worksheet[cellAddress].s = {
                    font: { bold: true, sz: 11, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "0078D4" } },
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } }
                    }
                };
            }

            for (let row = 1; row <= range.e.r; row++) {
                for (let col = range.s.c; col <= range.e.c; col++) {
                    const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                    if (!worksheet[cellAddress]) worksheet[cellAddress] = { t: 's', v: '' };
                    
                    if (!worksheet[cellAddress].s) {
                        worksheet[cellAddress].s = {};
                    }
                    
                    worksheet[cellAddress].s.border = {
                        top: { style: "thin", color: { rgb: "CCCCCC" } },
                        bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                        left: { style: "thin", color: { rgb: "CCCCCC" } },
                        right: { style: "thin", color: { rgb: "CCCCCC" } }
                    };
                    
                    if (!worksheet[cellAddress].s.alignment) {
                        worksheet[cellAddress].s.alignment = { horizontal: "left", vertical: "center" };
                    }
                }
            }

            worksheet['!freeze'] = { xSplit: 0, ySplit: 1 };
            worksheet['!views'] = [{ 
                state: 'frozen', 
                xSplit: 0,
                ySplit: 1, 
                topLeftCell: 'A2',
                activePane: 'bottomLeft'
            }];

            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Training Data');
            
            if (!workbook.Workbook) workbook.Workbook = {};
            if (!workbook.Workbook.Views) workbook.Workbook.Views = [{}];
            workbook.Workbook.Views[0].RTL = false;
            
            const filename = `Training_PowerBI_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, filename, { cellStyles: true });

            let filterDesc = '';
            let activeFilters = [];
            if (selectedYearFilter !== 'all') activeFilters.push(`Year: ${selectedYearFilter}`);
            if (selectedBatchFilter !== 'all') activeFilters.push(`Batch: ${selectedBatchFilter}`);
            if (selectedRankFilter !== 'all') activeFilters.push(`Rank: ${selectedRankFilter}`);
            if (searchQuery) activeFilters.push(`Search: "${searchQuery}"`);
            
            if (activeFilters.length > 0) {
                filterDesc = `\n\nüîç Filters: ${activeFilters.join(', ')}`;
            }
            
            alert(`üìä Power BI Export Complete!\n\n‚úÖ File: ${filename}\n‚úÖ Trainees: ${sortedCadets.length}\nüìå First row frozen\nüìä Cell borders added${filterDesc}\n\nReady for Power BI import!`);
        });

        function getTraineeStatus(cadet) {
            if (cadet.manualHighlight === 'blue') return 'functional';
            if (cadet.manualHighlight === 'green') return 'completed';
            if (cadet.manualHighlight === 'red') return 'special';
            
            const hasFirstIOE = cadet.firstIOEDate && cadet.firstIOEDate.trim() !== '';
            const hasFunctional = cadet.functionalDate && cadet.functionalDate.trim() !== '';
            const hasLRC = cadet.lrcDate && cadet.lrcDate.trim() !== '';
            const hasInterview = cadet.interviewDate && cadet.interviewDate.trim() !== '';
            
            if (hasFirstIOE && hasFunctional && hasLRC && hasInterview) return 'completed';
            if (hasFirstIOE && hasFunctional && !hasLRC && !hasInterview) return 'functional';
            return 'inprogress';
        }

        function getTraineeStatusLabel(cadet) {
            const status = getTraineeStatus(cadet);
            if (status === 'functional') return 'FUNCTIONAL';
            if (status === 'completed') return 'COMPLETED';
            if (status === 'special') return 'SPECIAL CASE';
            return 'IN PROGRESS';
        }
    </script>


</body>
</html>